"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[999],{4687:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var t=i(74848),s=i(28453);const a={sidebar_label:"Kubernetes",description:"Kubernetes Service Registration labels OpenBao pods with their current status for use with selectors."},r="Kubernetes service registration",o={id:"configuration/service-registration/kubernetes",title:"Kubernetes service registration",description:"Kubernetes Service Registration labels OpenBao pods with their current status for use with selectors.",source:"@site/content/docs/configuration/service-registration/kubernetes.mdx",sourceDirName:"configuration/service-registration",slug:"/configuration/service-registration/kubernetes",permalink:"/openbao/docs/configuration/service-registration/kubernetes",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/configuration/service-registration/kubernetes.mdx",tags:[],version:"current",frontMatter:{sidebar_label:"Kubernetes",description:"Kubernetes Service Registration labels OpenBao pods with their current status for use with selectors."},sidebar:"docs",previous:{title:"Overview",permalink:"/openbao/docs/configuration/service-registration/"},next:{title:"Overview",permalink:"/openbao/docs/configuration/storage/"}},l={},c=[{value:"Configuration",id:"configuration",level:2},{value:"Examples",id:"examples",level:2},{value:"Label definitions",id:"label-definitions",level:2},{value:"Working with OpenBao&#39;s service discovery labels",id:"working-with-openbaos-service-discovery-labels",level:2},{value:"Example service",id:"example-service",level:3},{value:"Example upgrades",id:"example-upgrades",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"kubernetes-service-registration",children:"Kubernetes service registration"}),"\n",(0,t.jsxs)(n.p,{children:["Kubernetes Service Registration tags OpenBao pods with their current status for\nuse with selectors. Service registration is only available when OpenBao is running in\n",(0,t.jsx)(n.a,{href:"/docs/concepts/ha",children:"High Availability mode"}),"."]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"HashiCorp Supported"})," \u2013 Kubernetes Service Registration is officially supported\nby HashiCorp."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-hcl",children:'service_registration "kubernetes" {\n  namespace      = "my-namespace"\n  pod_name       = "my-pod-name"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Alternatively, the namespace and pod name can be set through the following\nenvironment variables:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"VAULT_K8S_NAMESPACE"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.code,{children:"VAULT_K8S_POD_NAME"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["This allows you to set these parameters using\n",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/",children:"the Downward API"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"If using only environment variables, the service registration stanza declaring\nyou're using Kubernetes must still exist to indicate your intentions:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'service_registration "kubernetes" {}\n'})}),"\n",(0,t.jsx)(n.p,{children:"For service registration to succeed, OpenBao must be able to apply labels to pods\nin Kubernetes. The following RBAC rules are required to allow the service account\nassociated with the OpenBao pods to update its own pod specification:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'kind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  namespace: mynamespace\n  name: openbao-service-account\nrules:\n- apiGroups: [""]\n  resources: ["pods"]\n  verbs: ["get", "update", "patch"]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(n.p,{children:"Once properly configured, enabling service registration will cause Kubernetes pods\nto come up with the following labels:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: openbao\n  labels:\n    vault-active: "false"\n    vault-initialized: "true"\n    vault-perf-standby: "false"\n    vault-sealed: "false"\n    vault-version: 1.14.0\n'})}),"\n",(0,t.jsx)(n.p,{children:"After shutdowns, OpenBao pods will bear the following labels:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: openbao\n  labels:\n    vault-active: "false"\n    vault-initialized: "false"\n    vault-perf-standby: "false"\n    vault-sealed: "true"\n    vault-version: 1.14.0\n'})}),"\n",(0,t.jsx)(n.h2,{id:"label-definitions",children:"Label definitions"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"vault-active"})," ",(0,t.jsx)(n.code,{children:'(string: "true"/"false")'})," \u2013 Vault active is updated dynamically each time OpenBao's active status changes.\nTrue indicates that this OpenBao pod is currently the leader. False indicates that this OpenBao pod is currently a standby."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"vault-initialized"})," ",(0,t.jsx)(n.code,{children:'(string: "true"/"false")'})," \u2013 Vault initialized is updated dynamically each time OpenBao's initialization\nstatus changes. True indicates that OpenBao is currently initialized. False indicates the OpenBao is currently uninitialized."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"vault-sealed"})," ",(0,t.jsx)(n.code,{children:'(string: "true"/"false")'})," \u2013 Vault sealed is updated dynamically each\ntime OpenBao's sealed/unsealed status changes. True indicates that OpenBao is currently sealed. False indicates that OpenBao\nis currently unsealed."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"vault-version"})," ",(0,t.jsx)(n.code,{children:'(string: "1.14.0")'})," \u2013 Vault version is a string that will not change during a pod's lifecycle."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"working-with-openbaos-service-discovery-labels",children:"Working with OpenBao's service discovery labels"}),"\n",(0,t.jsx)(n.h3,{id:"example-service",children:"Example service"}),"\n",(0,t.jsxs)(n.p,{children:["With labels applied to the pod, services can be created using selectors to filter pods with specific OpenBao HA roles,\neffectively allowing direct communication with subsets of OpenBao pods. Note the ",(0,t.jsx)(n.code,{children:'vault-active: "true"'})," line below."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'apiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/instance: openbao\n    app.kubernetes.io/name: openbao\n    helm.sh/chart: openbao-0.1.2\n  name: openbao-active-us-east\n  namespace: default\nspec:\n  clusterIP: 10.7.254.51\n  ports:\n  - name: http\n    port: 8200\n    protocol: TCP\n    targetPort: 8200\n  - name: internal\n    port: 8201\n    protocol: TCP\n    targetPort: 8201\n  publishNotReadyAddresses: false\n  selector:\n    app.kubernetes.io/instance: openbao\n    app.kubernetes.io/name: openbao\n    component: server\n    vault-active: "true"\n  type: ClusterIP\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Also, by setting ",(0,t.jsx)(n.code,{children:"publishNotReadyAddresses: false"})," above, pods that have failed will be removed from the service pool."]}),"\n",(0,t.jsx)(n.p,{children:"With this active service in place, we now have a dedicated endpoint that will always reach the active node."}),"\n",(0,t.jsx)(n.h3,{id:"example-upgrades",children:"Example upgrades"}),"\n",(0,t.jsxs)(n.p,{children:["In conjunction with the pod labels and the ",(0,t.jsx)(n.code,{children:"OnDelete"})," upgrade strategy, upgrades are much easier to orchestrate:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell-session",children:"$ helm upgrade openbao --set='server.image.tag=1.14.0'\n\n$ kubectl delete pod --selector=vault-active=false \\\n    --selector=vault-version=1.2.3\n\n$ kubectl delete pod --selector=vault-active=true \\\n    --selector=vault-version=1.2.3\n"})}),"\n",(0,t.jsxs)(n.p,{children:["When deleting an instance of a pod, the ",(0,t.jsx)(n.code,{children:"Statefulset"})," defining the desired state of the cluster will reschedule the\ndeleted pods with the newest image."]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>o});var t=i(96540);const s={},a=t.createContext(s);function r(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);