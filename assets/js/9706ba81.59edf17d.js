"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2303],{77027:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var s=t(74848),i=t(28453);const a={layout:"docs",page_title:"Vault Lambda Extension",description:"The Vault Lambda Extension allows a Lambda function to read secrets from a Vault deployment."},r="Vault lambda extension",o={id:"platform/aws/lambda-extension",title:"lambda-extension",description:"The Vault Lambda Extension allows a Lambda function to read secrets from a Vault deployment.",source:"@site/content/docs/platform/aws/lambda-extension.mdx",sourceDirName:"platform/aws",slug:"/platform/aws/lambda-extension",permalink:"/openbao/docs/platform/aws/lambda-extension",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/platform/aws/lambda-extension.mdx",tags:[],version:"current",frontMatter:{layout:"docs",page_title:"Vault Lambda Extension",description:"The Vault Lambda Extension allows a Lambda function to read secrets from a Vault deployment."},sidebar:"tutorialSidebar",previous:{title:"Platforms",permalink:"/openbao/docs/platform/"},next:{title:"github-actions",permalink:"/openbao/docs/platform/github-actions"}},d={},l=[{value:"Usage",id:"usage",level:2},{value:"Adding the extension to your existing lambda and Vault infrastructure",id:"adding-the-extension-to-your-existing-lambda-and-vault-infrastructure",level:3},{value:"Requirements",id:"requirements",level:4},{value:"Step 1. configure Vault",id:"step-1-configure-vault",level:4},{value:"Step 2. option a) install the extension for lambda functions packaged in zip archives",id:"step-2-option-a-install-the-extension-for-lambda-functions-packaged-in-zip-archives",level:4},{value:"Step 2. option b) install the extension for lambda functions packaged in container images",id:"step-2-option-b-install-the-extension-for-lambda-functions-packaged-in-container-images",level:4},{value:"Step 3. configure vault-lambda-extension",id:"step-3-configure-vault-lambda-extension",level:4},{value:"Configuration",id:"configuration",level:2},{value:"AWS STS client configuration",id:"aws-sts-client-configuration",level:3},{value:"Caching",id:"caching",level:3},{value:"Limitations",id:"limitations",level:2},{value:"Performance impact",id:"performance-impact",level:2},{value:"Uploading to your own AWS account and region",id:"uploading-to-your-own-aws-account-and-region",level:2},{value:"Tutorial",id:"tutorial",level:2}];function c(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"vault-lambda-extension",children:"Vault lambda extension"}),"\n",(0,s.jsxs)(n.p,{children:["AWS Lambda lets you run code without provisioning and managing servers.\nThe ",(0,s.jsx)(n.a,{href:"https://github.com/hashicorp/vault-lambda-extension",children:"Vault Lambda Extension"})," utilizes the AWS Lambda Extensions API to help your Lambda function read secrets from your Vault deployment.\nYou can use the ",(0,s.jsx)(n.a,{href:"https://github.com/hashicorp/vault-lambda-extension/tree/main/quick-start",children:"quick-start"})," directory which has an end-to-end example if you would like to try out the extension from scratch."]}),"\n",(0,s.jsxs)(n.p,{children:["~> ",(0,s.jsx)(n.strong,{children:"Note"}),": If you decide to create one from scratch, be aware that this will create real infrastructure with an associated cost as per AWS' pricing."]}),"\n",(0,s.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.p,{children:"To use the extension, include one of the following ARNs as a layer in your\nLambda function, depending on your desired architecture."}),"\n",(0,s.jsx)(n.p,{children:"amd64 (x86_64):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"arn:aws:lambda:<your-region>:634166935893:layer:vault-lambda-extension:13\n"})}),"\n",(0,s.jsx)(n.p,{children:"arm64:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"arn:aws:lambda:<your-region>:634166935893:layer:vault-lambda-extension-arm64:1\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Where region may be any of ",(0,s.jsx)(n.code,{children:"af-south-1"}),", ",(0,s.jsx)(n.code,{children:"ap-east-1"}),", ",(0,s.jsx)(n.code,{children:"ap-northeast-1"}),",\n",(0,s.jsx)(n.code,{children:"ap-northeast-2"}),", ",(0,s.jsx)(n.code,{children:"ap-northeast-3"}),", ",(0,s.jsx)(n.code,{children:"ap-south-1"}),", ",(0,s.jsx)(n.code,{children:"ap-southeast-1"}),",\n",(0,s.jsx)(n.code,{children:"ap-southeast-2"}),", ",(0,s.jsx)(n.code,{children:"ca-central-1"}),", ",(0,s.jsx)(n.code,{children:"eu-central-1"}),", ",(0,s.jsx)(n.code,{children:"eu-north-1"}),", ",(0,s.jsx)(n.code,{children:"eu-south-1"}),",\n",(0,s.jsx)(n.code,{children:"eu-west-1"}),", ",(0,s.jsx)(n.code,{children:"eu-west-2"}),", ",(0,s.jsx)(n.code,{children:"eu-west-3"}),", ",(0,s.jsx)(n.code,{children:"me-south-1"}),", ",(0,s.jsx)(n.code,{children:"sa-east-1"}),", ",(0,s.jsx)(n.code,{children:"us-east-1"}),",\n",(0,s.jsx)(n.code,{children:"us-east-2"}),", ",(0,s.jsx)(n.code,{children:"us-west-1"}),", ",(0,s.jsx)(n.code,{children:"us-west-2"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The extension authenticates with Vault using ",(0,s.jsx)(n.a,{href:"/docs/auth/aws",children:"AWS IAM auth"}),",\nand all configuration is supplied via environment variables. There are two methods\nto read secrets, which can both be used side-by-side:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Recommended"}),": Make unauthenticated requests to the extension's local proxy\nserver at ",(0,s.jsx)(n.code,{children:"http://127.0.0.1:8200"}),", which will add an authentication header and\nproxy to the configured ",(0,s.jsx)(n.code,{children:"VAULT_ADDR"}),". Responses from Vault are returned without\nmodification."]}),"\n",(0,s.jsxs)(n.li,{children:["Configure environment variables such as ",(0,s.jsx)(n.code,{children:"VAULT_SECRET_PATH"})," for the extension\nto read a secret and write it to disk."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"adding-the-extension-to-your-existing-lambda-and-vault-infrastructure",children:"Adding the extension to your existing lambda and Vault infrastructure"}),"\n",(0,s.jsx)(n.h4,{id:"requirements",children:"Requirements"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"ARN of the role your Lambda runs as"}),"\n",(0,s.jsx)(n.li,{children:"An instance of Vault accessible from AWS Lambda"}),"\n",(0,s.jsxs)(n.li,{children:["An authenticated ",(0,s.jsx)(n.code,{children:"vault"})," client"]}),"\n",(0,s.jsx)(n.li,{children:"A secret in Vault that you want your Lambda to access, and a policy giving read access to it"}),"\n",(0,s.jsxs)(n.li,{children:["Your Lambda function must use one of the ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-extensions-api.html",children:"supported runtimes"})," for extensions"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"step-1-configure-vault",children:"Step 1. configure Vault"}),"\n",(0,s.jsx)(n.p,{children:"Enable the aws auth method."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ vault auth enable aws\n"})}),"\n",(0,s.jsx)(n.p,{children:"Configure the AWS client to use the default options."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ vault write -force auth/aws/config/client\n"})}),"\n",(0,s.jsx)(n.p,{children:"Create a role prefixed with the AWS environment name."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:'$ vault write auth/aws/role/vault-lambda-role \\\n    auth_type=iam \\\n    bound_iam_principal_arn="${YOUR_ARN}" \\\n    policies="${YOUR_POLICY}" \\\n    ttl=1h\n'})}),"\n",(0,s.jsx)(n.h4,{id:"step-2-option-a-install-the-extension-for-lambda-functions-packaged-in-zip-archives",children:"Step 2. option a) install the extension for lambda functions packaged in zip archives"}),"\n",(0,s.jsxs)(n.p,{children:["If you deploy your Lambda function as a zip file, you can add the extension\nto your Lambda layers using the console or ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html#configuration-layers-using",children:"cli"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"arn:aws:lambda:<your-region>:634166935893:layer:vault-lambda-extension:11\n"})}),"\n",(0,s.jsx)(n.h4,{id:"step-2-option-b-install-the-extension-for-lambda-functions-packaged-in-container-images",children:"Step 2. option b) install the extension for lambda functions packaged in container images"}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, if you deploy your Lambda function as a container image, simply\nplace the built binary in the ",(0,s.jsx)(n.code,{children:"/opt/extensions"})," directory of your image."]}),"\n",(0,s.jsxs)(n.p,{children:["Fetch the binary from\n",(0,s.jsx)(n.a,{href:"https://releases.hashicorp.com/vault-lambda-extension/",children:"releases.hashicorp.com"}),".\nThe following command requires cURL."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ curl --silent https://releases.hashicorp.com/vault-lambda-extension/0.5.0/vault-lambda-extension_0.5.0_linux_amd64.zip \\\n  --output vault-lambda-extension.zip\n"})}),"\n",(0,s.jsx)(n.p,{children:"Unzip the downloaded binary."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ unzip vault-lambda-extension.zip\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Optionally, you can verify the integrity of the downloaded zip using the release\narchive checksum verification instructions\n",(0,s.jsx)(n.a,{href:"https://www.hashicorp.com/security",children:"here"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Or to build the binary from source. This requires Golang installed. Run from the root of this repository."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ GOOS=linux GOARCH=amd64 go build -o vault-lambda-extension main.go\n"})}),"\n",(0,s.jsx)(n.h4,{id:"step-3-configure-vault-lambda-extension",children:"Step 3. configure vault-lambda-extension"}),"\n",(0,s.jsxs)(n.p,{children:["Configure the extension using ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html",children:"Lambda environment\nvariables"}),":"]}),"\n",(0,s.jsx)(n.p,{children:"Set the Vault API address."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ VAULT_ADDR=http://vault.example.com:8200\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Set the AWS IAM auth mount point (i.e. the path segment after ",(0,s.jsx)(n.code,{children:"auth/"})," from above)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ VAULT_AUTH_PROVIDER=aws\n"})}),"\n",(0,s.jsx)(n.p,{children:"Set the Vault role to authenticate as. Must be configured for the ARN of your\nLambda's role."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ VAULT_AUTH_ROLE=vault-lambda-role\n"})}),"\n",(0,s.jsxs)(n.p,{children:["The path to a secret in Vault. Can be static or dynamic. Unless\nVAULT_SECRET_FILE is specified, JSON response will be written to\n",(0,s.jsx)(n.code,{children:"/tmp/vault/secret.json"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ VAULT_SECRET_PATH=secret/lambda-app/token\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If everything is correctly set up, your Lambda function can then read secret\nmaterial from ",(0,s.jsx)(n.code,{children:"/tmp/vault/secret.json"}),". The exact contents of the JSON object\nwill depend on the secret read, but its schema is the ",(0,s.jsx)(n.a,{href:"https://github.com/hashicorp/vault/blob/api/v1.0.4/api/secret.go#L15",children:"Secret struct"}),"\nfrom the Vault API module."]}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can send normal Vault API requests over HTTP to the local\nproxy at ",(0,s.jsx)(n.code,{children:"http://127.0.0.1:8200"}),", and the extension will add authentication\nbefore forwarding the request. Vault responses will be returned unmodified.\nAlthough local communication is over plain HTTP, the proxy server will use TLS\nto communicate with Vault if configured to do so as detailed below."]}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["The extension is configured via ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/configuration-envvars.html",children:"Lambda environment variables"}),".\nMost of the ",(0,s.jsx)(n.a,{href:"/docs/commands#environment-variables",children:"Vault CLI client's environment variables"})," are available,\nas well as some additional variables to configure auth, which secret(s) to read and\nwhere to write secrets."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Environment variable"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Required"}),(0,s.jsx)(n.th,{children:"Example value"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VLE_VAULT_ADDR"})}),(0,s.jsxs)(n.td,{children:["Vault address to connect to. Takes precedence over ",(0,s.jsx)(n.code,{children:"VAULT_ADDR"})," so that clients of the proxy server can be configured using the standard ",(0,s.jsx)(n.code,{children:"VAULT_ADDR"})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://x.x.x.x:8200"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_ADDR"})}),(0,s.jsxs)(n.td,{children:["Vault address to connect to if ",(0,s.jsx)(n.code,{children:"VLE_VAULT_ADDR"})," is not set. Required if ",(0,s.jsx)(n.code,{children:"VLE_VAULT_ADDR"})," is not set"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"https://x.x.x.x:8200"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_AUTH_PROVIDER"})}),(0,s.jsx)(n.td,{children:"Name of the configured AWS IAM auth route on Vault"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"aws"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_AUTH_ROLE"})}),(0,s.jsx)(n.td,{children:"Vault role to authenticate as"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"lambda-app"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_IAM_SERVER_ID"})}),(0,s.jsxs)(n.td,{children:["Value to pass to the Vault server via the ",(0,s.jsxs)(n.a,{href:"/api-docs/auth/aws#iam_server_id_header_value",children:[(0,s.jsx)(n.code,{children:"X-Vault-AWS-IAM-Server-ID"})," HTTP Header for AWS Authentication"]})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"vault.example.com"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_SECRET_PATH"})}),(0,s.jsxs)(n.td,{children:["Secret path to read, written to ",(0,s.jsx)(n.code,{children:"/tmp/vault/secret.json"})," unless ",(0,s.jsx)(n.code,{children:"VAULT_SECRET_FILE"})," is specified"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"database/creds/lambda-app"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_SECRET_FILE"})}),(0,s.jsxs)(n.td,{children:["Path to write the JSON response for ",(0,s.jsx)(n.code,{children:"VAULT_SECRET_PATH"})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/db.json"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_SECRET_PATH_FOO"})}),(0,s.jsxs)(n.td,{children:["Additional secret path to read, where FOO can be any name, as long as a matching ",(0,s.jsx)(n.code,{children:"VAULT_SECRET_FILE_FOO"})," is specified"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"secret/lambda-app/token"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_SECRET_FILE_FOO"})}),(0,s.jsxs)(n.td,{children:["Must exist for any correspondingly named ",(0,s.jsx)(n.code,{children:"VAULT_SECRET_PATH_FOO"}),". Name has no further effect beyond matching to the correct path variable"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/token"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_RUN_MODE"})}),(0,s.jsxs)(n.td,{children:["Available options are ",(0,s.jsx)(n.code,{children:"default"}),", ",(0,s.jsx)(n.code,{children:"proxy"}),", and ",(0,s.jsx)(n.code,{children:"file"}),". Proxy mode makes requests to the extension's local proxy server. File mode configures the extension to read and write secrets to disk. Default mode uses both file and proxy mode. The default is ",(0,s.jsx)(n.code,{children:"default"}),"."]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"default"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_TOKEN_EXPIRY_GRACE_PERIOD"})}),(0,s.jsxs)(n.td,{children:["Period at the end of the proxy server's auth token TTL where it will consider the token expired and attempt to re-authenticate to Vault. Must have a unit and be parseable by ",(0,s.jsx)(n.code,{children:"time.Duration"}),". Defaults to 10s."]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"1m"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_STS_ENDPOINT_REGION"})}),(0,s.jsxs)(n.td,{children:["The region of the STS regional endpoint to authenticate with. If the AWS IAM auth mount specified uses a regional STS endpoint, then this needs to match the region of that endpoint. Defaults to using the global endpoint, or the region the Lambda resides in if ",(0,s.jsx)(n.code,{children:"AWS_STS_REGIONAL_ENDPOINTS"})," is set to ",(0,s.jsx)(n.code,{children:"regional"})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"eu-west-1"})})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["The remaining environment variables are not required, and function exactly as\ndescribed in the ",(0,s.jsx)(n.a,{href:"/docs/commands#environment-variables",children:"Vault Commands (CLI)"})," documentation. However,\nnote that ",(0,s.jsx)(n.code,{children:"VAULT_CLIENT_TIMEOUT"})," cannot extend the timeout beyond the 10s\ninitialization timeout imposed by the Extensions API when writing files to disk."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Environment variable"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Required"}),(0,s.jsx)(n.th,{children:"Example value"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_CACERT"})}),(0,s.jsxs)(n.td,{children:["Path to a PEM-encoded CA certificate ",(0,s.jsx)(n.em,{children:"file"})," on the local disk"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/ca.crt"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_CAPATH"})}),(0,s.jsxs)(n.td,{children:["Path to a ",(0,s.jsx)(n.em,{children:"directory"})," of PEM-encoded CA certificate files on the local disk"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/certs"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_CLIENT_CERT"})}),(0,s.jsx)(n.td,{children:"Path to a PEM-encoded client certificate on the local disk"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/client.crt"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_CLIENT_KEY"})}),(0,s.jsx)(n.td,{children:"Path to an unencrypted, PEM-encoded private key on disk which corresponds to the matching client certificate"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/tmp/client.key"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_CLIENT_TIMEOUT"})}),(0,s.jsxs)(n.td,{children:["Timeout for Vault requests. Default value is 60s. Ignored by proxy server. ",(0,s.jsx)(n.strong,{children:"Any value over 10s will exceed the Extensions API timeout and therefore have no effect"})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"5s"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_MAX_RETRIES"})}),(0,s.jsxs)(n.td,{children:["Maximum number of retries on ",(0,s.jsx)(n.code,{children:"5xx"})," error codes. Defaults to 2. Ignored by proxy server"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"2"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_SKIP_VERIFY"})}),(0,s.jsxs)(n.td,{children:["Do not verify Vault's presented certificate before communicating with it. Setting this variable is not recommended and voids Vault's ",(0,s.jsx)(n.a,{href:"/docs/internals/security",children:"security model"})]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"true"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_TLS_SERVER_NAME"})}),(0,s.jsx)(n.td,{children:"Name to use as the SNI host when connecting via TLS"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"vault.example.com"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_RATE_LIMIT"})}),(0,s.jsxs)(n.td,{children:["Only applies to a single invocation of the extension. See ",(0,s.jsx)(n.a,{href:"/docs/commands#environment-variables",children:"Vault Commands (CLI)"})," documentation for details. Ignored by proxy server"]}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"10"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_NAMESPACE"})}),(0,s.jsx)(n.td,{children:"The namespace to use for pre-configured secrets. Ignored by proxy server"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"education"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_DEFAULT_CACHE_TTL"})}),(0,s.jsx)(n.td,{children:"The time to live configuration (aka, TTL) of the cache used by proxy server. Must have a unit and be parsable as a time.Duration. Required for caching to be enabled."}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"15m"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_DEFAULT_CACHE_ENABLED"})}),(0,s.jsx)(n.td,{children:"Enable caching for all requests, without needing to set the X-Vault-Cache-Control header for each request. Must be set to a boolean value."}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"true"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_ASSUMED_ROLE_ARN"})}),(0,s.jsx)(n.td,{children:"Valid ARN of an IAM role that can be assumed by the execution role assigned to your Lambda function."}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"arn:aws:iam::123456789012:role/xaccounts3access"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"VAULT_LOG_LEVEL"})}),(0,s.jsx)(n.td,{children:"Log verbosity level, one of TRACE, DEBUG, INFO, WARN, ERROR, OFF. Defaults to INFO."}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"DEBUG"})})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"aws-sts-client-configuration",children:"AWS STS client configuration"}),"\n",(0,s.jsx)(n.p,{children:"In addition to Vault configuration, you can configure certain aspects of the STS\nclient the extension uses through the usual AWS environment variables. For example,\nif your Vault instance's IAM auth is configured to use regional STS endpoints:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:'$ vault write auth/aws/config/client \\\n     sts_endpoint="https://sts.eu-west-1.amazonaws.com" \\\n     sts_region="eu-west-1"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Then you may need to configure the extension's STS client to also use the regional\nSTS endpoint by setting ",(0,s.jsx)(n.code,{children:"AWS_STS_REGIONAL_ENDPOINTS=regional"}),", because both the AWS Golang\nSDK and Vault IAM auth method default to using the global endpoint in many regions.\nSee documentation on ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/credref/latest/refdocs/setting-global-sts_regional_endpoints.html",children:(0,s.jsx)(n.code,{children:"sts_regional_endpoints"})})," for more information."]}),"\n",(0,s.jsx)(n.h3,{id:"caching",children:"Caching"}),"\n",(0,s.jsxs)(n.p,{children:["Caching can be configured for the extension's local proxy server so that it does\nnot forward every HTTP request to Vault. The main consideration behind caching\ndesign is to make caching an explicit opt-in at the request level, so that it is\nonly enabled for scenarios where caching makes sense without negative impact in\nothers. To turn on caching, set the environment variable\n",(0,s.jsx)(n.code,{children:"VAULT_DEFAULT_CACHE_TTL"}),' to a valid value that is parsable as a time.Duration\nin Go, for example, "15m", "1h", "2m3s" or "1h2m3s", depending on application\nneeds. An invalid or negative value will be treated the same as a missing value,\nin which case, caching will not be set up and enabled.']}),"\n",(0,s.jsxs)(n.p,{children:['Then requests with HTTP method of "GET", and the HTTP header\n',(0,s.jsx)(n.code,{children:"X-Vault-Cache-Control: cache"})," will be returned directly from the cache if\nthere's a cache hit. On a cache miss the request will be forwarded to Vault and\nthe response returned and cached. If the header is set to\n",(0,s.jsx)(n.code,{children:"X-Vault-Cache-Control: recache"}),", the cache lookup will be skipped, and the\nrequest will be forwarded to Vault and the response returned and cached.\nCurrently, the cache key is a hash of the request URL path, headers, body, and\ntoken."]}),"\n",(0,s.jsxs)(n.p,{children:["Caching may also be enabled for all requests by setting the environment variable\n",(0,s.jsx)(n.code,{children:"VAULT_DEFAULT_CACHE_ENABLED"})," to ",(0,s.jsx)(n.code,{children:"true"}),". Then all requests will be fetched and/or\ncached as though the header ",(0,s.jsx)(n.code,{children:"X-Vault-Cache-Control: cache"})," was present. Setting\nthe header to ",(0,s.jsx)(n.code,{children:"nocache"})," on a request will opt-out of caching entirely in this\nconfiguration. Setting the header to ",(0,s.jsx)(n.code,{children:"recache"})," will skip the cache lookup and\nreturn and cache the response from Vault as described previously."]}),"\n",(0,s.jsxs)(n.p,{children:["~> ",(0,s.jsx)(n.strong,{children:"Warning!"})," The Vault Lambda Extension's cache is only in-memory\nand will not be persisted when the Lambda execution environment shuts down.\nIn order words, the cache TTL is capped to the duration of the Lambda execution environment."]}),"\n",(0,s.jsx)(n.h2,{id:"limitations",children:"Limitations"}),"\n",(0,s.jsxs)(n.p,{children:["Secrets written to disk or returned from the proxy server will not be automatically\nrefreshed when they expire. This is particularly important if you configure the\nextension to write secrets to disk, because the extension will only write to disk\nonce per execution environment, rather than once per function invocation. If you\nuse ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html#configuration-concurrency-provisioned",children:"provisioned concurrency"})," or if your Lambda\nis invoked often enough that execution contexts live beyond the lifetime of the\nsecret, then secrets on disk are likely to become invalid."]}),"\n",(0,s.jsxs)(n.p,{children:["In line with ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html",children:"Lambda best practices"}),", we recommend avoiding\nwriting secrets to disk where possible, and exclusively consuming secrets via\nthe proxy server. However, the proxy server will still not perform any additional\nprocessing with returned secrets such as automatic lease renewal. The proxy server's\nown Vault auth token is the only thing that gets automatically refreshed. It will\nsynchronously refresh its own token before proxying requests if the token is\nexpired (including a grace window), and it will attempt to renew its token if the\ntoken is nearly expired but renewable."]}),"\n",(0,s.jsx)(n.h2,{id:"performance-impact",children:"Performance impact"}),"\n",(0,s.jsxs)(n.p,{children:["AWS Lambda pricing is based on ",(0,s.jsx)(n.a,{href:"https://aws.amazon.com/lambda/pricing/",children:"number of invocations, time of execution and memory\nused"}),". The following table details some approximate performance\nrelated statistics to help assess the cost impact of this extension. Note that AWS\nLambda allocates ",(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/configuration-memory.html",children:"CPU power in proportion to memory"})," so results\nwill vary widely. These benchmarks were run with the minimum 128MB of memory allocated\nso aim to give an approximate baseline."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Metric"}),(0,s.jsx)(n.th,{children:"Value"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Derivation"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Layer size"}),(0,s.jsx)(n.td,{children:"8.5MB"}),(0,s.jsx)(n.td,{children:"The size of the unpacked extension binary"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"ls -la"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Init latency"}),(0,s.jsx)(n.td,{children:"8.5ms (standard deviation 2.4ms) + one network round trip to authenticate to Vault"}),(0,s.jsx)(n.td,{children:"Extension initialization time in a new execution environment. Authentication round trip time will be highly deployment-dependent"}),(0,s.jsx)(n.td,{children:"Instrumented in code"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Invoke latency"}),(0,s.jsx)(n.td,{children:"<1ms"}),(0,s.jsx)(n.td,{children:"The base processing time for each function invocation, assuming no calls to the proxy server"}),(0,s.jsx)(n.td,{children:"Instrumented in code"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Memory impact"}),(0,s.jsx)(n.td,{children:"12MB"}),(0,s.jsx)(n.td,{children:'The marginal impact on "Max Memory Used" when running the extension'}),(0,s.jsx)(n.td,{children:"As reported by Lambda when running Hello World function with and without extension"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"uploading-to-your-own-aws-account-and-region",children:"Uploading to your own AWS account and region"}),"\n",(0,s.jsx)(n.p,{children:"If you would like to upload the extension as a Lambda layer in your own AWS\naccount and region, you can do the following:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ curl --silent https://releases.hashicorp.com/vault-lambda-extension/0.5.0/vault-lambda-extension_0.5.0_linux_amd64.zip \\\n  --output vault-lambda-extension.zip\n"})}),"\n",(0,s.jsx)(n.p,{children:"Set your target AWS region."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:'$ export REGION="YOUR REGION HERE"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Upload the extension as a Lambda layer."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:'$ aws lambda publish-layer-version \\\n     --layer-name vault-lambda-extension \\\n     --zip-file  "fileb://vault-lambda-extension.zip" \\\n     --region "${REGION}"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"tutorial",children:"Tutorial"}),"\n",(0,s.jsxs)(n.p,{children:["For step-by-step instructions, refer to the ",(0,s.jsx)(n.a,{href:"/tutorials/app-integration/aws-lambda",children:"Vault AWS Lambda Extension"})," tutorial for details on how to create an AWS Lambda function and use the Vault Lambda Extension to authenticate with Vault."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(96540);const i={},a=s.createContext(i);function r(e){const n=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);