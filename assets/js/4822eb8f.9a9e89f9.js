"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3392],{59990:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>c,toc:()=>l});var i=t(74848),r=t(28453);const s={layout:"docs",page_title:"PKI - Secrets Engine: Troubleshooting ACME",description:"Troubleshoot problems with ACME clients and OpenBao PKI Secrets Engine's ACME server."},o="Troubleshoot PKI Secrets Engine and ACME",c={id:"secrets/pki/troubleshooting-acme",title:"Troubleshoot PKI Secrets Engine and ACME",description:"Troubleshoot problems with ACME clients and OpenBao PKI Secrets Engine's ACME server.",source:"@site/content/docs/secrets/pki/troubleshooting-acme.mdx",sourceDirName:"secrets/pki",slug:"/secrets/pki/troubleshooting-acme",permalink:"/openbao/docs/secrets/pki/troubleshooting-acme",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/secrets/pki/troubleshooting-acme.mdx",tags:[],version:"current",frontMatter:{layout:"docs",page_title:"PKI - Secrets Engine: Troubleshooting ACME",description:"Troubleshoot problems with ACME clients and OpenBao PKI Secrets Engine's ACME server."},sidebar:"tutorialSidebar",previous:{title:"PKI secrets engine - setup and usage",permalink:"/openbao/docs/secrets/pki/setup"},next:{title:"RabbitMQ secrets engine",permalink:"/openbao/docs/secrets/rabbitmq"}},a={},l=[{value:"Error: Unable to register an account with the ACME server",id:"error-unable-to-register-an-account-with-the-acme-server",level:2},{value:"Symptoms",id:"symptoms",level:3},{value:"Cause",id:"cause",level:3},{value:"Resolution",id:"resolution",level:3},{value:"Error: Failed to verify eab",id:"error-failed-to-verify-eab",level:2},{value:"Symptoms",id:"symptoms-1",level:3},{value:"Cause",id:"cause-1",level:3},{value:"Resolution",id:"resolution-1",level:3},{value:"Error: ACME validation failed for <code>{challenge_id}</code>",id:"error-acme-validation-failed-for-challenge_id",level:2},{value:"Symptoms",id:"symptoms-2",level:3},{value:"Cause",id:"cause-2",level:3},{value:"Resolution",id:"resolution-2",level:3},{value:"Error: The client lacks sufficient authorization: account in status: revoked",id:"error-the-client-lacks-sufficient-authorization-account-in-status-revoked",level:2},{value:"Symptoms",id:"symptoms-3",level:3},{value:"Cause",id:"cause-3",level:3},{value:"Resolution",id:"resolution-3",level:3},{value:"Get help",id:"get-help",level:2},{value:"Tutorial",id:"tutorial",level:2},{value:"API",id:"api",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"troubleshoot-pki-secrets-engine-and-acme",children:"Troubleshoot PKI Secrets Engine and ACME"}),"\n",(0,i.jsx)(n.p,{children:"Solve common problems related to ACME client integration with OpenBao PKI\nSecrets Engine's ACME server."}),"\n",(0,i.jsx)(n.h2,{id:"error-unable-to-register-an-account-with-the-acme-server",children:"Error: Unable to register an account with the ACME server"}),"\n",(0,i.jsx)(n.h3,{id:"symptoms",children:"Symptoms"}),"\n",(0,i.jsxs)(n.p,{children:["When registering a new account without an ",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#acme-external-account-bindings",children:"External Account Binding\n(EAB)"}),", the\nOpenBao Server rejects the request with a response like:"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Unable to register an account with ACME server"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["with further information provided in the debug logs (in the case of\n",(0,i.jsx)(n.code,{children:"certbot"}),"):"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"Server requires external account binding."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"or, if the client incorrectly contacted the server, an error like:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"The request must include a value for the 'externalAccountBinding' field"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In either case, a new account needs to be created with an EAB token created\nby OpenBao."}),"\n",(0,i.jsx)(n.h3,{id:"cause",children:"Cause"}),"\n",(0,i.jsxs)(n.p,{children:["If a server has been updated to require ",(0,i.jsx)(n.code,{children:"eab_policy=always-required"})," in the\n",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#set-acme-configuration",children:"ACME configuration"}),",\nnew account registration (and reuse of existing accounts will fail)."]}),"\n",(0,i.jsx)(n.h3,{id:"resolution",children:"Resolution"}),"\n",(0,i.jsxs)(n.p,{children:["Using an OpenBao token, ",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#get-acme-eab-binding-token",children:"fetch a new external account\nbinding"})," for\nthe ",(0,i.jsx)(n.a,{href:"/api-docs/v1.14.x/secret/pki#acme-directories",children:"desired directory"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"$ bao write -f pki/roles/my-role-name/acme/new-eab\n...\ndirectory roles/my-role-name/acme/directory\nid        bc8088d9-3816-5177-ae8e-d8393265f7dd\nkey       MHcCAQE... additional data elided ...\n...\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then pass this new EAB token into the ACME client. For example, with\n",(0,i.jsx)(n.code,{children:"certbot"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"$ certbot [... additional parameters ...] \\\n    --server https://cluster-b.openbao.example.com/v1/pki/roles/my-role-name/acme/directory \\\n    --eab-kid bc8088d9-3816-5177-ae8e-d8393265f7dd \\\n    --eab-hmac-key MHcCAQE... additional data elided ...\n"})}),"\n",(0,i.jsx)(n.p,{children:"Ensure that the ACME directory passed to the ACME client matches that\nfetched from the OpenBao."}),"\n",(0,i.jsx)(n.h2,{id:"error-failed-to-verify-eab",children:"Error: Failed to verify eab"}),"\n",(0,i.jsx)(n.h3,{id:"symptoms-1",children:"Symptoms"}),"\n",(0,i.jsx)(n.p,{children:"When initializing a new account against this OpenBao server, the ACME client\nmight error with a message like:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"The client lacks sufficient authorization :: failed to verify eab"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This is caused by requesting an EAB from a directory not matching the\none the client used."}),"\n",(0,i.jsx)(n.h3,{id:"cause-1",children:"Cause"}),"\n",(0,i.jsx)(n.p,{children:"If an EAB account token is incorrectly used with the wrong directory, the\nACME server will reject the request with an error about insufficient\npermissions."}),"\n",(0,i.jsx)(n.h3,{id:"resolution-1",children:"Resolution"}),"\n",(0,i.jsxs)(n.p,{children:["Ensure the requested EAB token matches the directory. For a given directory\nat ",(0,i.jsx)(n.code,{children:"/some/path/acme/directory"}),", fetch EAB tokens from\n",(0,i.jsx)(n.code,{children:"/some/path/amce/new-eab"}),". The remaining resolution steps are the same as\nfor ",(0,i.jsx)(n.a,{href:"#debugging-account-registration-failures",children:"debugging account registration\nfailures"}),"."]}),"\n",(0,i.jsxs)(n.h2,{id:"error-acme-validation-failed-for-challenge_id",children:["Error: ACME validation failed for ",(0,i.jsx)(n.code,{children:"{challenge_id}"})]}),"\n",(0,i.jsx)(n.h3,{id:"symptoms-2",children:"Symptoms"}),"\n",(0,i.jsx)(n.p,{children:"When viewing the OpenBao server logs or attempting to fetch a certificate via\nan ACME client, an error like:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"ACME validation failed for a465a798-4400-6c17-6735-e1b38c23de38-tls-alpn-01: ..."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"indicates that the server was unable to validate this challenge accepted\nby the client."}),"\n",(0,i.jsx)(n.h3,{id:"cause-2",children:"Cause"}),"\n",(0,i.jsxs)(n.p,{children:["OpenBao can not verify the server's identity through the client's requested\n",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#acme-challenge-types",children:"challenge type"})," (",(0,i.jsx)(n.code,{children:"dns-01"}),",\n",(0,i.jsx)(n.code,{children:"http-01"}),", or ",(0,i.jsx)(n.code,{children:"tls-alpn-01"}),"). OpenBao will not issue the certificate requested\nby the client."]}),"\n",(0,i.jsx)(n.h3,{id:"resolution-2",children:"Resolution"}),"\n",(0,i.jsxs)(n.p,{children:["Ensure that DNS is configured correctly from the OpenBao server's perspective,\nincluding setting ",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#dns_resolver",children:"any custom DNS resolver"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Ensure that any firewalls are set up to allow OpenBao to talk to the relevant\nsystems (the DNS server in the case of ",(0,i.jsx)(n.code,{children:"dns-01"}),", port 80 on the target\nmachine for ",(0,i.jsx)(n.code,{children:"http-01"}),", or port 443 on the target machine for ",(0,i.jsx)(n.code,{children:"tls-alpn-01"}),"\nchallenges)."]}),"\n",(0,i.jsx)(n.h2,{id:"error-the-client-lacks-sufficient-authorization-account-in-status-revoked",children:"Error: The client lacks sufficient authorization: account in status: revoked"}),"\n",(0,i.jsx)(n.h3,{id:"symptoms-3",children:"Symptoms"}),"\n",(0,i.jsx)(n.p,{children:"When attempting to renew a certificate, the ACME client reports an error:"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"The client lacks sufficient authorization: account in status: revoked"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"cause-3",children:"Cause"}),"\n",(0,i.jsxs)(n.p,{children:["If you run a ",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#tidy_acme",children:"manual tidy"})," or have\n",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki#configure-automatic-tidy",children:"auto-tidy"})," enabled\nwith `tidy_acme=true, OpenBao will periodically remove stale ACME accounts."]}),"\n",(0,i.jsx)(n.p,{children:"Connections from clients using removed accounts will be rejected."}),"\n",(0,i.jsx)(n.h3,{id:"resolution-3",children:"Resolution"}),"\n",(0,i.jsx)(n.p,{children:"Refer to the ACME client's documentation for removing cached local\nconfiguration and setup a new account, specifying any EABs as required."}),"\n",(0,i.jsx)(n.h2,{id:"get-help",children:"Get help"}),"\n",(0,i.jsx)(n.p,{children:"Please provide the following information when contacting Hashicorp Support\nor filing a GitHub issue to help with our investigation and reproducibility:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"ACME client name and version"}),"\n",(0,i.jsx)(n.li,{children:"ACME client logs and/or output"}),"\n",(0,i.jsxs)(n.li,{children:["OpenBao server ",(0,i.jsx)(n.strong,{children:"DEBUG"})," level logs"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"tutorial",children:"Tutorial"}),"\n",(0,i.jsxs)(n.p,{children:["Refer to the ",(0,i.jsx)(n.a,{href:"/tutorials/secrets-management/pki-engine",children:"Build Your Own Certificate Authority (CA)"}),"\nguide for a step-by-step tutorial."]}),"\n",(0,i.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,i.jsxs)(n.p,{children:["The PKI secrets engine has a full HTTP API. Please see the\n",(0,i.jsx)(n.a,{href:"/api-docs/secret/pki",children:"PKI secrets engine API"})," for more\ndetails."]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var i=t(96540);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);