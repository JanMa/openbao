"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2736],{64722:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>c,toc:()=>l});var i=s(74848),t=s(28453);const r={description:"OIDC provider configuration for Kubernetes"},o=void 0,c={id:"auth/jwt/oidc-providers/kubernetes",title:"kubernetes",description:"OIDC provider configuration for Kubernetes",source:"@site/content/docs/auth/jwt/oidc-providers/kubernetes.mdx",sourceDirName:"auth/jwt/oidc-providers",slug:"/auth/jwt/oidc-providers/kubernetes",permalink:"/openbao/docs/auth/jwt/oidc-providers/kubernetes",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/auth/jwt/oidc-providers/kubernetes.mdx",tags:[],version:"current",frontMatter:{description:"OIDC provider configuration for Kubernetes"},sidebar:"docs",previous:{title:"keycloak",permalink:"/openbao/docs/auth/jwt/oidc-providers/keycloak"},next:{title:"okta",permalink:"/openbao/docs/auth/jwt/oidc-providers/okta"}},a={},l=[{value:"Kubernetes",id:"kubernetes",level:2},{value:"Using service account issuer discovery",id:"using-service-account-issuer-discovery",level:3},{value:"Using JWT validation public keys",id:"using-jwt-validation-public-keys",level:3},{value:"Creating a role and logging in",id:"creating-a-role-and-logging-in",level:3},{value:"Specifying TTL and audience",id:"specifying-ttl-and-audience",level:3}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"kubernetes",children:"Kubernetes"}),"\n",(0,i.jsx)(n.p,{children:"Kubernetes can function as an OIDC provider such that OpenBao can validate its\nservice account tokens using JWT/OIDC auth."}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note:"})," The JWT auth engine does ",(0,i.jsx)(n.strong,{children:"not"})," use Kubernetes' ",(0,i.jsx)(n.code,{children:"TokenReview"})," API\nduring authentication, and instead uses public key cryptography to verify the\ncontents of JWTs. This means tokens that have been revoked by Kubernetes will\nstill be considered valid by OpenBao until their expiry time. To mitigate this\nrisk, use short TTLs for service account tokens or use\n",(0,i.jsx)(n.a,{href:"/docs/auth/kubernetes",children:"Kubernetes auth"})," which ",(0,i.jsx)(n.em,{children:"does"})," use the ",(0,i.jsx)(n.code,{children:"TokenReview"})," API."]})}),"\n",(0,i.jsx)(n.h3,{id:"using-service-account-issuer-discovery",children:"Using service account issuer discovery"}),"\n",(0,i.jsx)(n.p,{children:"When using service account issuer discovery, you only need to provide the JWT\nauth mount with an OIDC discovery URL, and sometimes a TLS certificate authority\nto trust. This makes it the most straightforward method to configure if your\nKubernetes cluster meets the requirements."}),"\n",(0,i.jsx)(n.p,{children:"Kubernetes cluster requirements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-issuer-discovery",children:(0,i.jsx)(n.code,{children:"ServiceAccountIssuerDiscovery"})})," feature enabled.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Present from 1.18, defaults to enabled from 1.20."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["kube-apiserver's ",(0,i.jsx)(n.code,{children:"--service-account-issuer"})," flag is set to a URL that is\nreachable from OpenBao. Public by default for most managed Kubernetes solutions."]}),"\n",(0,i.jsxs)(n.li,{children:["Must use short-lived service account tokens when logging in.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Tokens mounted into pods default to short-lived from 1.21."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Configuration steps:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Ensure OIDC discovery URLs do not require authentication, as detailed\n",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-issuer-discovery",children:"here"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl create clusterrolebinding oidc-reviewer  \\\n   --clusterrole=system:service-account-issuer-discovery \\\n   --group=system:unauthenticated\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Find the issuer URL of the cluster."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"ISSUER=\"$(kubectl get --raw /.well-known/openid-configuration | jq -r '.issuer')\"\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Enable and configure JWT auth in OpenBao."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If OpenBao is running in Kubernetes:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl exec openbao-0 -- bao auth enable jwt\nkubectl exec openbao-0 -- bao write auth/jwt/config \\\n   oidc_discovery_url=https://kubernetes.default.svc.cluster.local \\\n   oidc_discovery_ca_pem=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Alternatively, if OpenBao is ",(0,i.jsx)(n.em,{children:"not"})," running in Kubernetes:"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Note:"})," When OpenBao is outside the cluster, the ",(0,i.jsx)(n.code,{children:"$ISSUER"})," endpoint below may\nor may not be reachable. If not, you can configure JWT auth using\n",(0,i.jsx)(n.a,{href:"#using-jwt-validation-public-keys",children:(0,i.jsx)(n.code,{children:"jwt_validation_pubkeys"})})," instead."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bao auth enable jwt\nbao write auth/jwt/config oidc_discovery_url="${ISSUER}"\n'})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Configure a role and log in as detailed ",(0,i.jsx)(n.a,{href:"#creating-a-role-and-logging-in",children:"below"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"using-jwt-validation-public-keys",children:"Using JWT validation public keys"}),"\n",(0,i.jsx)(n.p,{children:"This method can be useful if Kubernetes' API is not reachable from OpenBao or if\nyou would like a single JWT auth mount to service multiple Kubernetes clusters\nby chaining their public signing keys."}),"\n",(0,i.jsx)(n.p,{children:"Kubernetes cluster requirements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#service-account-issuer-discovery",children:(0,i.jsx)(n.code,{children:"ServiceAccountIssuerDiscovery"})})," feature enabled.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Present from 1.18, defaults to enabled from 1.20."}),"\n",(0,i.jsxs)(n.li,{children:["This requirement can be avoided if you can access the Kubernetes master\nnodes to read the public signing key directly from disk at\n",(0,i.jsx)(n.code,{children:"/etc/kubernetes/pki/sa.pub"}),". In this case, you can skip the steps to\nretrieve and then convert the key as it will already be in PEM format."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Must use short-lived service account tokens when logging in.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Tokens mounted into pods default to short-lived from 1.21."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Configuration steps:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Fetch the service account signing public key from your cluster's JWKS URI."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Query the jwks_uri specified in /.well-known/openid-configuration\nkubectl get --raw \"$(kubectl get --raw /.well-known/openid-configuration | jq -r '.jwks_uri' | sed -r 's/.*\\.[^/]+(.*)/\\1/')\"\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Convert the keys from JWK format to PEM. You can use a CLI tool or an online\nconverter such as ",(0,i.jsx)(n.a,{href:"https://8gwifi.org/jwkconvertfunctions.jsp",children:"this one"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Configure the JWT auth mount with those public keys."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bao write auth/jwt/config \\\n   jwt_validation_pubkeys="-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9...\n-----END PUBLIC KEY-----","-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9...\n-----END PUBLIC KEY-----"\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Configure a role and log in as detailed ",(0,i.jsx)(n.a,{href:"#creating-a-role-and-logging-in",children:"below"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"creating-a-role-and-logging-in",children:"Creating a role and logging in"}),"\n",(0,i.jsxs)(n.p,{children:["Once your JWT auth mount is configured, you're ready to configure a role and\nlog in. The following assumes you use the projected service account token\navailable in all pods by default. See ",(0,i.jsx)(n.a,{href:"#specifying-ttl-and-audience",children:"Specifying TTL and audience"}),"\nbelow if you'd like to control the audience or TTL."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Choose any value from the array of default audiences. In these examples,\nthere is only one audience in the ",(0,i.jsx)(n.code,{children:"aud"})," array,\n",(0,i.jsx)(n.code,{children:"https://kubernetes.default.svc.cluster.local"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["To find the default audiences, either create a fresh token (requires\n",(0,i.jsx)(n.code,{children:"kubectl"})," v1.24.0+):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell-session",children:'$ kubectl create token default | cut -f2 -d. | base64 --decode\n{"aud":["https://kubernetes.default.svc.cluster.local"], ... "sub":"system:serviceaccount:default:default"}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Or read a token from a running pod's filesystem:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell-session",children:'$ kubectl exec my-pod -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -f2 -d. | base64 --decode\n{"aud":["https://kubernetes.default.svc.cluster.local"], ... "sub":"system:serviceaccount:default:default"}\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Create a role for JWT auth that the ",(0,i.jsx)(n.code,{children:"default"})," service account from the\n",(0,i.jsx)(n.code,{children:"default"})," namespace can use."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bao write auth/jwt/role/my-role \\\n   role_type="jwt" \\\n   bound_audiences="<AUDIENCE-FROM-PREVIOUS-STEP>" \\\n   user_claim="sub" \\\n   bound_subject="system:serviceaccount:default:default" \\\n   policies="default" \\\n   ttl="1h"\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Pods or other clients with access to a service account JWT can then log in."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'bao write auth/jwt/login \\\n   role=my-role \\\n   jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token\n# OR equivalent to:\ncurl \\\n   --fail \\\n   --request POST \\\n   --header "X-Vault-Request: true" \\\n   --data \'{"jwt":"<JWT-TOKEN-HERE>","role":"my-role"}\' \\\n   "${VAULT_ADDR}/v1/auth/jwt/login"\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"specifying-ttl-and-audience",children:"Specifying TTL and audience"}),"\n",(0,i.jsxs)(n.p,{children:["If you would like to specify a custom TTL or audience for service account tokens,\nthe following pod spec illustrates a volume mount that overrides the default\nadmission injected token. This is especially relevant if you are unable to\ndisable the ",(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/#options",children:"--service-account-extend-token-expiration"}),"\nflag for ",(0,i.jsx)(n.code,{children:"kube-apiserver"})," and want to use short TTLs."]}),"\n",(0,i.jsxs)(n.p,{children:["When using the resulting token, you will need to set ",(0,i.jsx)(n.code,{children:"bound_audiences=openbao"}),"\nwhen creating roles in OpenBao's JWT auth mount."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx\nspec:\n  # automountServiceAccountToken is redundant in this example because the\n  # mountPath used overlaps with the default path. The overlap stops the default\n  # admission injected token from being created. You can use this option to\n  # ensure only\xa0a single token is mounted if you choose a different mount path.\n  automountServiceAccountToken: false\n  containers:\n    - name: nginx\n      image: nginx\n      volumeMounts:\n      - name: custom-token\n        mountPath: /var/run/secrets/kubernetes.io/serviceaccount\n  volumes:\n  - name: custom-token\n    projected:\n      defaultMode: 420\n      sources:\n      - serviceAccountToken:\n          path: token\n          expirationSeconds: 600 # 10 minutes is the minimum TTL\n          audience: openbao        # Must match your JWT role's `bound_audiences`\n      # The remaining sources are included to mimic the rest of the default\n      # admission injected volume.\n      - configMap:\n          name: kube-root-ca.crt\n          items:\n          - key: ca.crt\n            path: ca.crt\n      - downwardAPI:\n          items:\n          - fieldRef:\n              apiVersion: v1\n              fieldPath: metadata.namespace\n            path: namespace\n"})})]})}function d(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var i=s(96540);const t={},r=i.createContext(t);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);