"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8007],{56802:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>l});var r=o(74848),i=o(28453);const t={description:"OIDC provider configuration for Azure Active Directory"},c=void 0,s={id:"auth/jwt/oidc-providers/azuread",title:"azuread",description:"OIDC provider configuration for Azure Active Directory",source:"@site/content/docs/auth/jwt/oidc-providers/azuread.mdx",sourceDirName:"auth/jwt/oidc-providers",slug:"/auth/jwt/oidc-providers/azuread",permalink:"/openbao/docs/auth/jwt/oidc-providers/azuread",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/auth/jwt/oidc-providers/azuread.mdx",tags:[],version:"current",frontMatter:{description:"OIDC provider configuration for Azure Active Directory"},sidebar:"docs",previous:{title:"auth0",permalink:"/openbao/docs/auth/jwt/oidc-providers/auth0"},next:{title:"forgerock",permalink:"/openbao/docs/auth/jwt/oidc-providers/forgerock"}},d={},l=[{value:"Azure active directory (AAD)",id:"azure-active-directory-aad",level:2},{value:"Connect AD group with OpenBao external group",id:"connect-ad-group-with-openbao-external-group",level:3},{value:"Optional azure-specific configuration",id:"optional-azure-specific-configuration",level:3}];function a(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"azure-active-directory-aad",children:"Azure active directory (AAD)"}),"\n",(0,r.jsxs)(n.p,{children:["~> ",(0,r.jsx)(n.strong,{children:"Note:"})," Azure Active Directory Applications that have custom signing keys as a result of using\nthe ",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-claims-mapping",children:"claims-mapping"}),"\nfeature are currently not supported for OIDC authentication."]}),"\n",(0,r.jsxs)(n.p,{children:["Reference: ",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-protocols-oidc",children:"Azure Active Directory v2.0 and the OpenID Connect protocol"})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Choose your Azure tenant."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Go to ",(0,r.jsx)(n.strong,{children:"Azure Active Directory"})," and\n",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app",children:"register an application"}),"\nfor OpenBao."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Add Redirect URIs with the "Web" type. You may include two redirect URIs,\none for CLI access another one for OpenBao UI access.'}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"http://localhost:8250/oidc/callback"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"https://hostname:port_number/ui/vault/auth/oidc/oidc/callback"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:['Record the "Application (client) ID" as you will need it as the ',(0,r.jsx)(n.code,{children:"oidc_client_id"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Under ",(0,r.jsx)(n.strong,{children:"Endpoints"}),", copy the OpenID Connect metadata document URL, omitting the ",(0,r.jsx)(n.code,{children:"/well-known..."})," portion."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["The endpoint URL (",(0,r.jsx)(n.code,{children:"oidc_discovery_url"}),") will look like: ",(0,r.jsx)(n.a,{href:"https://login.microsoftonline.com/tenant-guid-dead-beef-aaaa-aaaa/v2.0",children:"https://login.microsoftonline.com/tenant-guid-dead-beef-aaaa-aaaa/v2.0"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Under ",(0,r.jsx)(n.strong,{children:"Certificates & secrets"}),",\n",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app#add-a-client-secret",children:"add a client secret"}),"\nRecord the secret's value as you will need it as the ",(0,r.jsx)(n.code,{children:"oidc_client_secret"})," for OpenBao."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"connect-ad-group-with-openbao-external-group",children:"Connect AD group with OpenBao external group"}),"\n",(0,r.jsxs)(n.p,{children:["Reference: ",(0,r.jsx)(n.a,{href:"/tutorials/auth-methods/oidc-auth-azure",children:"Azure Active Directory with OIDC Auth Method and External Groups"})]}),"\n",(0,r.jsxs)(n.p,{children:["To connect the AD group with a ",(0,r.jsx)(n.a,{href:"/docs/secrets/identity#external-vs-internal-groups",children:"OpenBao external groups"}),",\nyou will need\n",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-gb/azure/active-directory/develop/azure-ad-endpoint-comparison",children:"Azure AD v2.0 endpoints"}),".\nYou should set up a ",(0,r.jsx)(n.a,{href:"/tutorials/policies/policies",children:"OpenBao policy"})," for the Azure AD group to use."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Go to ",(0,r.jsx)(n.strong,{children:"Azure Active Directory"})," and choose your OpenBao application."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Go to ",(0,r.jsx)(n.strong,{children:"Token configuration"})," and ",(0,r.jsx)(n.strong,{children:"Add groups claim"}),'. Select "All" or "SecurityGroup" based on\n',(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/hybrid/how-to-connect-fed-group-claims",children:"which groups for a user"}),"\nyou want returned in the claim."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"In OpenBao, enable the OIDC auth method."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Configure the OIDC auth method with the ",(0,r.jsx)(n.code,{children:"oidc_client_id"})," (application ID), ",(0,r.jsx)(n.code,{children:"oidc_client_secret"}),"\n(client secret), and ",(0,r.jsx)(n.code,{children:"oidc_discovery_url"})," (endpoint URL) you recorded from Azure."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'bao write auth/oidc/config \\\n   oidc_client_id="your_client_id" \\\n   oidc_client_secret="your_client_secret" \\\n   default_role="your_default_role" \\\n   oidc_discovery_url="https://login.microsoftonline.com/tenant_id/v2.0"\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Configure the ",(0,r.jsx)(n.a,{href:"/api-docs/auth/jwt#create-role",children:"OIDC Role"})," with the following:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"user_claim"})," should be ",(0,r.jsx)(n.code,{children:'"sub"'})," or ",(0,r.jsx)(n.code,{children:'"oid"'})," following the\n",(0,r.jsx)(n.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/id-tokens#using-claims-to-reliably-identify-a-user-subject-and-object-id",children:"recommendation"}),"\nfrom Azure."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"allowed_redirect_uris"})," should be the two redirect URIs for OpenBao CLI and UI access."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"groups_claim"})," should be set to ",(0,r.jsx)(n.code,{children:'"groups"'}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"oidc_scopes"})," should be set to ",(0,r.jsx)(n.code,{children:'"https://graph.microsoft.com/.default"'}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'bao write auth/oidc/role/your_default_role \\\n   user_claim="sub" \\\n   allowed_redirect_uris="http://localhost:8250/oidc/callback,https://online_version_hostname:port_number/ui/vault/auth/oidc/oidc/callback"  \\\n   groups_claim="groups" \\\n   oidc_scopes="https://graph.microsoft.com/.default" \\\n   policies=default\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["In OpenBao, create the ",(0,r.jsx)(n.a,{href:"/api-docs/secret/identity/group",children:"external group"}),".\nRecord the group ID as you will need it for the group alias."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["From OpenBao, retrieve the ",(0,r.jsx)(n.a,{href:"/api-docs/system/auth#list-auth-methods",children:"OIDC accessor ID"}),"\nfrom the OIDC auth method as you will need it for the group alias's ",(0,r.jsx)(n.code,{children:"mount_accessor"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Go to the Azure AD Group you want to attach to OpenBao's external group. Record the ",(0,r.jsx)(n.code,{children:"objectId"}),"\nas you will need it as the group alias name in OpenBao."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["In OpenBao, create a ",(0,r.jsx)(n.a,{href:"/api-docs/secret/identity/group-alias",children:"group alias"}),"\nfor the external group and set the ",(0,r.jsx)(n.code,{children:"objectId"})," as the group alias name."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'bao write identity/group-alias \\\n   name="your_ad_group_object_id" \\\n   mount_accessor="openbao_oidc_accessor_id" \\\n   canonical_id="openbao_external_group_id"\n'})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"optional-azure-specific-configuration",children:"Optional azure-specific configuration"}),"\n",(0,r.jsxs)(n.p,{children:["If a user is a member of more than 200 groups (directly or indirectly), Azure will\nsend ",(0,r.jsx)(n.code,{children:"_claim_names"})," and ",(0,r.jsx)(n.code,{children:"_claim_sources"}),". For example, returned claims might look like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "_claim_names": {\n    "groups": "src1"\n  },\n  "_claim_sources": {\n    "src1": {\n      "endpoint": "https://graph.windows.net...."\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"The OIDC auth method role can be configured to include the user ID in the endpoint URL,\nwhich will be used by OpenBao to retrieve the groups for the user. Additional API permissions\nmust be added to the Azure app in order to request the additional groups from the Microsoft\nGraph API."}),"\n",(0,r.jsx)(n.p,{children:"To set the proper permissions on the Azure app:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Locate the application under "App Registrations" in Azure'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Navigate to the "API Permissions" page for the application'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Add a permission"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Select "Microsoft Graph"'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Select "Delegated permissions"'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Add the ",(0,r.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/graph/permissions-reference#delegated-permissions-93",children:"User.Read"})," permission"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:'Check the "Grant admin consent for Default Directory" checkbox'}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Configure the OIDC auth method in OpenBao by setting ",(0,r.jsx)(n.code,{children:'"provider_config"'})," to Azure."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'bao write auth/oidc/config -<<"EOH"\n{\n  "oidc_client_id": "your_client_id",\n  "oidc_client_secret": "your_client_secret",\n  "default_role": "your_default_role",\n  "oidc_discovery_url": "https://login.microsoftonline.com/tenant_id/v2.0",\n  "provider_config": {\n     "provider": "azure"\n  }\n}\nEOH\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Add ",(0,r.jsx)(n.code,{children:'"profile"'})," to ",(0,r.jsx)(n.code,{children:"oidc_scopes"})," so the user's ID comes back on the JWT."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'bao write auth/oidc/role/your_default_role \\\n user_claim="email" \\\n allowed_redirect_uris="http://localhost:8250/oidc/callback,https://online_version_hostname:port_number/ui/vault/auth/oidc/oidc/callback"  \\\n groups_claim="groups" \\\n oidc_scopes="profile" \\\n policies="default"\n'})}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,n,o)=>{o.d(n,{R:()=>c,x:()=>s});var r=o(96540);const i={},t=r.createContext(i);function c(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);