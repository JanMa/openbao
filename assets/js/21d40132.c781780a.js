"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6974],{66825:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>d});var s=t(74848),r=t(28453),o=t(11470),a=t(19365);const i={sidebar_label:"Kubernetes",description:"The Kubernetes auth method allows automated authentication of Kubernetes\nService Accounts."},c="Kubernetes auth method",l={id:"auth/kubernetes",title:"Kubernetes auth method",description:"The Kubernetes auth method allows automated authentication of Kubernetes\nService Accounts.",source:"@site/content/docs/auth/kubernetes.mdx",sourceDirName:"auth",slug:"/auth/kubernetes",permalink:"/docs/auth/kubernetes",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/auth/kubernetes.mdx",tags:[],version:"current",frontMatter:{sidebar_label:"Kubernetes",description:"The Kubernetes auth method allows automated authentication of Kubernetes\nService Accounts."},sidebar:"docs",previous:{title:"Kerberos",permalink:"/docs/auth/kerberos"},next:{title:"LDAP",permalink:"/docs/auth/ldap"}},u={},d=[{value:"Authentication",id:"authentication",level:2},{value:"Via the CLI",id:"via-the-cli",level:3},{value:"Via the API",id:"via-the-api",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Kubernetes 1.21",id:"kubernetes-121",level:2},{value:"How to work with short-lived kubernetes tokens",id:"how-to-work-with-short-lived-kubernetes-tokens",level:3},{value:"Use local service account token as the reviewer JWT",id:"use-local-service-account-token-as-the-reviewer-jwt",level:4},{value:"Use the OpenBao client&#39;s JWT as the reviewer JWT",id:"use-the-openbao-clients-jwt-as-the-reviewer-jwt",level:4},{value:"Continue using long-lived tokens",id:"continue-using-long-lived-tokens",level:4},{value:"Use JWT auth",id:"use-jwt-auth",level:4},{value:"Discovering the service account <code>issuer</code>",id:"discovering-the-service-account-issuer",level:3},{value:"Configuring kubernetes",id:"configuring-kubernetes",level:2},{value:"API",id:"api",level:2},{value:"Code example",id:"code-example",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"kubernetes-auth-method",children:"Kubernetes auth method"}),"\n",(0,s.jsxs)(n.p,{children:["~> ",(0,s.jsx)(n.strong,{children:"Note"}),": This engine can use external X.509 certificates as part of TLS or signature validation.\nVerifying signatures against X.509 certificates that use SHA-1 is deprecated and is no longer\nusable without a workaround. See the\n",(0,s.jsx)(n.a,{href:"/docs/deprecation/faq#q-what-is-the-impact-of-removing-support-for-x-509-certificates-with-signatures-that-use-sha-1",children:"deprecation FAQ"}),"\nfor more information."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"kubernetes"})," auth method can be used to authenticate with OpenBao using a\nKubernetes Service Account Token. This method of authentication makes it easy to\nintroduce an OpenBao token into a Kubernetes Pod."]}),"\n",(0,s.jsxs)(n.p,{children:["You can also use a Kubernetes Service Account Token to ",(0,s.jsx)(n.a,{href:"/docs/auth/jwt/oidc-providers/kubernetes",children:"log in via JWT auth"}),".\nSee the section on ",(0,s.jsx)(n.a,{href:"#how-to-work-with-short-lived-kubernetes-tokens",children:"How to work with short-lived Kubernetes tokens"}),"\nfor a summary of why you might want to use JWT auth instead and how it compares to\nKubernetes auth."]}),"\n",(0,s.jsxs)(n.p,{children:["-> ",(0,s.jsx)(n.strong,{children:"Note:"})," If you are upgrading to Kubernetes v1.21+, ensure the config option\n",(0,s.jsx)(n.code,{children:"disable_iss_validation"})," is set to true. Assuming the default mount path, you\ncan check with ",(0,s.jsx)(n.code,{children:"bao read -field disable_iss_validation auth/kubernetes/config"}),".\nSee ",(0,s.jsx)(n.a,{href:"#kubernetes-1-21",children:"Kubernetes 1.21"})," below for more details."]}),"\n",(0,s.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,s.jsx)(n.h3,{id:"via-the-cli",children:"Via the CLI"}),"\n",(0,s.jsxs)(n.p,{children:["The default path is ",(0,s.jsx)(n.code,{children:"/kubernetes"}),". If this auth method was enabled at a\ndifferent path, specify ",(0,s.jsx)(n.code,{children:"-path=/my-path"})," in the CLI."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ bao write auth/kubernetes/login role=demo jwt=...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"via-the-api",children:"Via the API"}),"\n",(0,s.jsxs)(n.p,{children:["The default endpoint is ",(0,s.jsx)(n.code,{children:"auth/kubernetes/login"}),". If this auth method was enabled\nat a different path, use that value instead of ",(0,s.jsx)(n.code,{children:"kubernetes"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:'$ curl \\\n    --request POST \\\n    --data \'{"jwt": "<your service account jwt>", "role": "demo"}\' \\\n    http://127.0.0.1:8200/v1/auth/kubernetes/login\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The response will contain a token at ",(0,s.jsx)(n.code,{children:"auth.client_token"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "auth": {\n    "client_token": "38fe9691-e623-7238-f618-c94d4e7bc674",\n    "accessor": "78e87a38-84ed-2692-538f-ca8b9f400ab3",\n    "policies": ["default"],\n    "metadata": {\n      "role": "demo",\n      "service_account_name": "myapp",\n      "service_account_namespace": "default",\n      "service_account_secret_name": "myapp-token-pd21c",\n      "service_account_uid": "aa9aa8ff-98d0-11e7-9bb7-0800276d99bf"\n    },\n    "lease_duration": 2764800,\n    "renewable": true\n  }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Auth methods must be configured in advance before users or machines can\nauthenticate. These steps are usually completed by an operator or configuration\nmanagement tool."}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Enable the Kubernetes auth method:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bao auth enable kubernetes\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Use the ",(0,s.jsx)(n.code,{children:"/config"})," endpoint to configure OpenBao to talk to Kubernetes. Use\n",(0,s.jsx)(n.code,{children:"kubectl cluster-info"})," to validate the Kubernetes host address and TCP port.\nFor the list of available configuration options, please see the\n",(0,s.jsx)(n.a,{href:"/api-docs/auth/kubernetes",children:"API documentation"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'bao write auth/kubernetes/config \\\n    token_reviewer_jwt="<your reviewer service account JWT>" \\\n    kubernetes_host=https://192.168.99.100:<your TCP port or blank for 443> \\\n    kubernetes_ca_cert=@ca.crt\n'})}),"\n",(0,s.jsxs)(n.p,{children:["!> ",(0,s.jsx)(n.strong,{children:"Note:"})," The pattern OpenBao uses to authenticate Pods depends on sharing\nthe JWT token over the network. Given the ",(0,s.jsx)(n.a,{href:"/docs/internals/security",children:"security model of\nOpenBao"}),", this is allowable because OpenBao is\npart of the trusted compute base. In general, Kubernetes applications should\n",(0,s.jsx)(n.strong,{children:"not"})," share this JWT with other applications, as it allows API calls to be\nmade on behalf of the Pod and can result in unintended access being granted\nto 3rd parties."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create a named role:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"bao write auth/kubernetes/role/demo \\\n    bound_service_account_names=myapp \\\n    bound_service_account_namespaces=default \\\n    policies=default \\\n    ttl=1h\n"})}),"\n",(0,s.jsx)(n.p,{children:'This role authorizes the "myapp" service account in the default\nnamespace and it gives it the default policy.'}),"\n",(0,s.jsxs)(n.p,{children:["For the complete list of configuration options, please see the ",(0,s.jsx)(n.a,{href:"/api-docs/auth/kubernetes",children:"API\ndocumentation"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"kubernetes-121",children:"Kubernetes 1.21"}),"\n",(0,s.jsxs)(n.p,{children:["Starting in version ",(0,s.jsx)(n.a,{href:"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.21.md#api-change-2",children:"1.21"}),", the Kubernetes\n",(0,s.jsx)(n.code,{children:"BoundServiceAccountTokenVolume"})," feature defaults to enabled. This changes the\nJWT token mounted into containers by default in two ways that are important for\nKubernetes auth:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"It has an expiry time and is bound to the lifetime of the pod and service account."}),"\n",(0,s.jsxs)(n.li,{children:["The value of the JWT's ",(0,s.jsx)(n.code,{children:'"iss"'})," claim depends on the cluster's configuration."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The changes to token lifetime are important when configuring the\n",(0,s.jsx)(n.a,{href:"/api-docs/auth/kubernetes#token_reviewer_jwt",children:(0,s.jsx)(n.code,{children:"token_reviewer_jwt"})})," option.\nIf a short-lived token is used,\nKubernetes will revoke it as soon as the pod or service account are deleted, or\nif the expiry time passes, and OpenBao will no longer be able to use the\n",(0,s.jsx)(n.code,{children:"TokenReview"})," API. See ",(0,s.jsx)(n.a,{href:"#how-to-work-with-short-lived-kubernetes-tokens",children:"How to work with short-lived Kubernetes tokens"}),"\nbelow for details on handling this change."]}),"\n",(0,s.jsxs)(n.p,{children:["In response to the issuer changes, Kubernetes auth has been updated to not\nvalidate the issuer by default. The Kubernetes API does the same validation when\nreviewing tokens, so enabling issuer validation on the OpenBao side is\nduplicated work. Without disabling OpenBao's issuer validation, it is not\npossible for a single Kubernetes auth configuration to work for default mounted\npod tokens with both Kubernetes 1.20 and 1.21.. See ",(0,s.jsxs)(n.a,{href:"#discovering-the-service-account-issuer",children:["Discovering the service\naccount ",(0,s.jsx)(n.code,{children:"issuer"})]})," below for guidance if\nyou wish to enable issuer validation in OpenBao."]}),"\n",(0,s.jsx)(n.h3,{id:"how-to-work-with-short-lived-kubernetes-tokens",children:"How to work with short-lived kubernetes tokens"}),"\n",(0,s.jsx)(n.p,{children:"There are a few different ways to configure auth for Kubernetes pods when\ndefault mounted pod tokens are short-lived, each with their own tradeoffs. This\ntable summarizes the options, each of which is explained in more detail below."}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Option"}),(0,s.jsx)(n.th,{children:"All tokens are short-lived"}),(0,s.jsx)(n.th,{children:"Can revoke tokens early"}),(0,s.jsx)(n.th,{children:"Other considerations"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Use local token as reviewer JWT"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:"Requires OpenBao to be deployed on the Kubernetes cluster"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Use client JWT as reviewer JWT"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:"Operational overhead"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Use long-lived token as reviewer JWT"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Use JWT auth instead"}),(0,s.jsx)(n.td,{children:"Yes"}),(0,s.jsx)(n.td,{children:"No"}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["-> ",(0,s.jsx)(n.strong,{children:"Note:"})," By default, Kubernetes currently extends the lifetime of admission\ninjected service account tokens to a year to help smooth the transition to\nshort-lived tokens. If you would like to disable this, set\n",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kube-apiserver/#options",children:"--service-account-extend-token-expiration=false"})," for\n",(0,s.jsx)(n.code,{children:"kube-apiserver"})," or specify your own ",(0,s.jsx)(n.code,{children:"serviceAccountToken"})," volume mount. See\n",(0,s.jsx)(n.a,{href:"/docs/auth/jwt/oidc-providers/kubernetes#specifying-ttl-and-audience",children:"here"})," for an example."]}),"\n",(0,s.jsx)(n.h4,{id:"use-local-service-account-token-as-the-reviewer-jwt",children:"Use local service account token as the reviewer JWT"}),"\n",(0,s.jsxs)(n.p,{children:["When running OpenBao in a Kubernetes pod the recommended option is to use the pod's local\nservice account token. OpenBao will periodically re-read the file to support\nshort-lived tokens. To use the local token and CA certificate, omit\n",(0,s.jsx)(n.code,{children:"token_reviewer_jwt"})," and ",(0,s.jsx)(n.code,{children:"kubernetes_ca_cert"})," when configuring the auth method.\nOpenBao will attempt to load them from ",(0,s.jsx)(n.code,{children:"token"})," and ",(0,s.jsx)(n.code,{children:"ca.crt"})," respectively inside\nthe default mount folder ",(0,s.jsx)(n.code,{children:"/var/run/secrets/kubernetes.io/serviceaccount/"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"bao write auth/kubernetes/config \\\n    kubernetes_host=https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT\n"})}),"\n",(0,s.jsx)(n.h4,{id:"use-the-openbao-clients-jwt-as-the-reviewer-jwt",children:"Use the OpenBao client's JWT as the reviewer JWT"}),"\n",(0,s.jsxs)(n.p,{children:["When configuring Kubernetes auth, you can omit the ",(0,s.jsx)(n.code,{children:"token_reviewer_jwt"}),", and OpenBao\nwill use the OpenBao client's JWT as its own auth token when communicating with\nthe Kubernetes ",(0,s.jsx)(n.code,{children:"TokenReview"})," API. If OpenBao is running in Kubernetes, you also need\nto set ",(0,s.jsx)(n.code,{children:"disable_local_ca_jwt=true"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["This means OpenBao does not store any JWTs and allows you to use short-lived tokens\neverywhere but adds some operational overhead to maintain the cluster role\nbindings on the set of service accounts you want to be able to authenticate with\nOpenBao. Each client of OpenBao would need the ",(0,s.jsx)(n.code,{children:"system:auth-delegator"})," ClusterRole:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl create clusterrolebinding openbao-client-auth-delegator \\\n  --clusterrole=system:auth-delegator \\\n  --group=group1 \\\n  --serviceaccount=default:svcaccount1 \\\n  ...\n"})}),"\n",(0,s.jsx)(n.h4,{id:"continue-using-long-lived-tokens",children:"Continue using long-lived tokens"}),"\n",(0,s.jsxs)(n.p,{children:["You can create a long-lived secret using the instructions ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-a-service-account-api-token",children:"here"}),"\nand use that as the ",(0,s.jsx)(n.code,{children:"token_reviewer_jwt"}),". In this example, the ",(0,s.jsx)(n.code,{children:"openbao"})," service\naccount would need the ",(0,s.jsx)(n.code,{children:"system:auth-delegator"})," ClusterRole:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f - <<EOF\napiVersion: v1\nkind: Secret\nmetadata:\n  name: openbao-k8s-auth-secret\n  annotations:\n    kubernetes.io/service-account.name: openbao\ntype: kubernetes.io/service-account-token\nEOF\n"})}),"\n",(0,s.jsx)(n.p,{children:"Using this maintains previous workflows but does not benefit from the improved\nsecurity posture of short-lived tokens."}),"\n",(0,s.jsx)(n.h4,{id:"use-jwt-auth",children:"Use JWT auth"}),"\n",(0,s.jsxs)(n.p,{children:["Kubernetes auth is specialized to use Kubernetes' ",(0,s.jsx)(n.code,{children:"TokenReview"})," API. However, the\nJWT tokens Kubernetes generates can also be verified using Kubernetes as an OIDC\nprovider. The JWT auth method documentation has ",(0,s.jsx)(n.a,{href:"/docs/auth/jwt/oidc-providers/kubernetes",children:"instructions"})," for\nsetting up JWT auth with Kubernetes as the OIDC provider."]}),"\n",(0,s.jsx)(n.p,{children:"This solution allows you to use short-lived tokens for all clients and removes\nthe need for a reviewer JWT. However, the client tokens cannot be revoked before\ntheir TTL expires, so it is recommended to keep the TTL short with that\nlimitation in mind."}),"\n",(0,s.jsxs)(n.h3,{id:"discovering-the-service-account-issuer",children:["Discovering the service account ",(0,s.jsx)(n.code,{children:"issuer"})]}),"\n",(0,s.jsxs)(n.p,{children:["-> ",(0,s.jsx)(n.strong,{children:"Note:"})," ",(0,s.jsx)(n.code,{children:"disable_iss_validation"})," and ",(0,s.jsx)(n.code,{children:"issuer"})," are deprecated and the\ndefault for ",(0,s.jsx)(n.code,{children:"disable_iss_validation"})," has changed to ",(0,s.jsx)(n.code,{children:"true"})," for new Kubernetes\nauth mounts. The following section only applies if you have set\n",(0,s.jsx)(n.code,{children:"disable_iss_validation=false"})," , but ",(0,s.jsx)(n.code,{children:"disable_iss_validation=true"})," is the new\nrecommended value for all versions of OpenBao."]}),"\n",(0,s.jsxs)(n.p,{children:["Kubernetes 1.21+ clusters may require setting the service account\n",(0,s.jsx)(n.a,{href:"/api-docs/auth/kubernetes#issuer",children:(0,s.jsx)(n.code,{children:"issuer"})})," to the same value as\n",(0,s.jsx)(n.code,{children:"kube-apiserver"}),"'s ",(0,s.jsx)(n.code,{children:"--service-account-issuer"})," flag. This is because the service\naccount JWTs for these clusters may have an issuer specific to the cluster\nitself, instead of the old default of ",(0,s.jsx)(n.code,{children:"kubernetes/serviceaccount"}),". If you are\nunable to check this value directly, you can run the following and look for the\n",(0,s.jsx)(n.code,{children:'"iss"'})," field to find the required value:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'echo \'{"apiVersion": "authentication.k8s.io/v1", "kind": "TokenRequest"}\' \\\n  | kubectl create -f- --raw /api/v1/namespaces/default/serviceaccounts/default/token \\\n  | jq -r \'.status.token\' \\\n  | cut -d . -f2 \\\n  | base64 -d\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Most clusters will also have that information available at the\n",(0,s.jsx)(n.code,{children:".well-known/openid-configuration"})," endpoint:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl get --raw /.well-known/openid-configuration | jq -r .issuer\n"})}),"\n",(0,s.jsx)(n.p,{children:"This value is then used when configuring Kubernetes auth, e.g.:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'bao write auth/kubernetes/config \\\n  kubernetes_host="https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT" \\\n  issuer="\\"test-aks-cluster-dns-d6cbb78e.hcp.uksouth.azmk8s.io\\""\n'})}),"\n",(0,s.jsx)(n.h2,{id:"configuring-kubernetes",children:"Configuring kubernetes"}),"\n",(0,s.jsxs)(n.p,{children:["This auth method accesses the ",(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#tokenreview-v1-authentication-k8s-io",children:"Kubernetes TokenReview API"})," to\nvalidate the provided JWT is still valid. Kubernetes should be running with\n",(0,s.jsx)(n.code,{children:"--service-account-lookup"}),". This is defaulted to true from Kubernetes 1.7.\nOtherwise deleted tokens in Kubernetes will not be properly revoked and\nwill be able to authenticate to this auth method."]}),"\n",(0,s.jsx)(n.p,{children:"Service Accounts used in this auth method will need to have access to the\nTokenReview API. If Kubernetes is configured to use RBAC roles, the Service\nAccount should be granted permissions to access this API. The following\nexample ClusterRoleBinding could be used to grant these permissions:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: role-tokenreview-binding\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:auth-delegator\nsubjects:\n  - kind: ServiceAccount\n    name: openbao-auth\n    namespace: default\n"})}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,s.jsxs)(n.p,{children:["The Kubernetes Auth Plugin has a full HTTP API. Please see the\n",(0,s.jsx)(n.a,{href:"/api-docs/auth/kubernetes",children:"API docs"})," for more details."]}),"\n",(0,s.jsx)(n.h2,{id:"code-example",children:"Code example"}),"\n",(0,s.jsx)(n.p,{children:"The following example demonstrates the Kubernetes auth method to authenticate\nwith OpenBao."}),"\n",(0,s.jsx)(o.A,{children:(0,s.jsx)(a.A,{value:"Go",heading:"Go",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-go",children:'package main\n\nimport (\n\t"fmt"\n\t"os"\n\n\topenbao "github.com/openbao/openbao/api"\n\tauth "github.com/openbao/openbao/api/auth/kubernetes"\n)\n\n// Fetches a key-value secret (kv-v2) after authenticating to OpenBao with a Kubernetes service account.\n// For a more in-depth setup explanation, please see the relevant readme in the hashicorp/vault-examples repo.\nfunc getSecretWithKubernetesAuth() (string, error) {\n\t// If set, the VAULT_ADDR environment variable will be the address that\n\t// your pod uses to communicate with OpenBao.\n\tconfig := openbao.DefaultConfig() // modify for more granular configuration\n\n\tclient, err := openbao.NewClient(config)\n\tif err != nil {\n\t\treturn "", fmt.Errorf("unable to initialize OpenBao client: %w", err)\n\t}\n\n\t// The service-account token will be read from the path where the token\'s\n\t// Kubernetes Secret is mounted. By default, Kubernetes will mount it to\n\t// /var/run/secrets/kubernetes.io/serviceaccount/token, but an administrator\n\t// may have configured it to be mounted elsewhere.\n\t// In that case, we\'ll use the option WithServiceAccountTokenPath to look\n\t// for the token there.\n\tk8sAuth, err := auth.NewKubernetesAuth(\n\t\t"dev-role-k8s",\n\t\tauth.WithServiceAccountTokenPath("path/to/service-account-token"),\n\t)\n\tif err != nil {\n\t\treturn "", fmt.Errorf("unable to initialize Kubernetes auth method: %w", err)\n\t}\n\n\tauthInfo, err := client.Auth().Login(context.TODO(), k8sAuth)\n\tif err != nil {\n\t\treturn "", fmt.Errorf("unable to log in with Kubernetes auth: %w", err)\n\t}\n\tif authInfo == nil {\n\t\treturn "", fmt.Errorf("no auth info was returned after login")\n\t}\n\n\t// get secret from OpenBao, from the default mount path for KV v2 in dev mode, "secret"\n\tsecret, err := client.KVv2("secret").Get(context.Background(), "creds")\n\tif err != nil {\n\t\treturn "", fmt.Errorf("unable to read secret: %w", err)\n\t}\n\n\t// data map can contain more than one key-value pair,\n\t// in this case we\'re just grabbing one of them\n\tvalue, ok := secret.Data["password"].(string)\n\tif !ok {\n\t\treturn "", fmt.Errorf("value type assertion failed: %T %#v", secret.Data["password"], secret.Data["password"])\n\t}\n\n\treturn value, nil\n}\n'})})})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},19365:(e,n,t)=>{t.d(n,{A:()=>a});t(96540);var s=t(34164);const r={tabItem:"tabItem_Ymn6"};var o=t(74848);function a(e){let{children:n,hidden:t,className:a}=e;return(0,o.jsx)("div",{role:"tabpanel",className:(0,s.A)(r.tabItem,a),hidden:t,children:n})}},11470:(e,n,t)=>{t.d(n,{A:()=>w});var s=t(96540),r=t(34164),o=t(23104),a=t(56347),i=t(205),c=t(57485),l=t(31682),u=t(89466);function d(e){return s.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:n,children:t}=e;return(0,s.useMemo)((()=>{const e=n??function(e){return d(e).map((e=>{let{props:{value:n,label:t,attributes:s,default:r}}=e;return{value:n,label:t,attributes:s,default:r}}))}(t);return function(e){const n=(0,l.X)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function p(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function b(e){let{queryString:n=!1,groupId:t}=e;const r=(0,a.W6)(),o=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,c.aZ)(o),(0,s.useCallback)((e=>{if(!o)return;const n=new URLSearchParams(r.location.search);n.set(o,e),r.replace({...r.location,search:n.toString()})}),[o,r])]}function f(e){const{defaultValue:n,queryString:t=!1,groupId:r}=e,o=h(e),[a,c]=(0,s.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const s=t.find((e=>e.default))??t[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:n,tabValues:o}))),[l,d]=b({queryString:t,groupId:r}),[f,v]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[r,o]=(0,u.Dv)(t);return[r,(0,s.useCallback)((e=>{t&&o.set(e)}),[t,o])]}({groupId:r}),m=(()=>{const e=l??f;return p({value:e,tabValues:o})?e:null})();(0,i.A)((()=>{m&&c(m)}),[m]);return{selectedValue:a,selectValue:(0,s.useCallback)((e=>{if(!p({value:e,tabValues:o}))throw new Error(`Can't select invalid tab value=${e}`);c(e),d(e),v(e)}),[d,v,o]),tabValues:o}}var v=t(92303);const m={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=t(74848);function j(e){let{className:n,block:t,selectedValue:s,selectValue:a,tabValues:i}=e;const c=[],{blockElementScrollPositionUntilNextRender:l}=(0,o.a_)(),u=e=>{const n=e.currentTarget,t=c.indexOf(n),r=i[t].value;r!==s&&(l(n),a(r))},d=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=c.indexOf(e.currentTarget)+1;n=c[t]??c[0];break}case"ArrowLeft":{const t=c.indexOf(e.currentTarget)-1;n=c[t]??c[c.length-1];break}}n?.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":t},n),children:i.map((e=>{let{value:n,label:t,attributes:o}=e;return(0,x.jsx)("li",{role:"tab",tabIndex:s===n?0:-1,"aria-selected":s===n,ref:e=>c.push(e),onKeyDown:d,onClick:u,...o,className:(0,r.A)("tabs__item",m.tabItem,o?.className,{"tabs__item--active":s===n}),children:t??n},n)}))})}function g(e){let{lazy:n,children:t,selectedValue:r}=e;const o=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=o.find((e=>e.props.value===r));return e?(0,s.cloneElement)(e,{className:"margin-top--md"}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:o.map(((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==r})))})}function k(e){const n=f(e);return(0,x.jsxs)("div",{className:(0,r.A)("tabs-container",m.tabList),children:[(0,x.jsx)(j,{...e,...n}),(0,x.jsx)(g,{...e,...n})]})}function w(e){const n=(0,v.A)();return(0,x.jsx)(k,{...e,children:d(e.children)},String(n))}},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var s=t(96540);const r={},o=s.createContext(r);function a(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);