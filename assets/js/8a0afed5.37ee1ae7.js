"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[1277],{25234:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>t,metadata:()=>a,toc:()=>h});var i=s(74848),r=s(28453);const t={layout:"docs",page_title:"operator diagnose - Command",description:'"bao operator diagnose" is a new operator-centric command, focused on providing a clear description \nof what is working in OpenBao, and what is not working. The command focuses on why OpenBao cannot serve requests,\nbut will also warn on configurations or statuses that it deems to be unsafe in some way. '},o="operator diagnose",a={id:"commands/operator/diagnose",title:"operator diagnose",description:'"bao operator diagnose" is a new operator-centric command, focused on providing a clear description \nof what is working in OpenBao, and what is not working. The command focuses on why OpenBao cannot serve requests,\nbut will also warn on configurations or statuses that it deems to be unsafe in some way. ',source:"@site/content/docs/commands/operator/diagnose.mdx",sourceDirName:"commands/operator",slug:"/commands/operator/diagnose",permalink:"/openbao/docs/commands/operator/diagnose",draft:!1,unlisted:!1,editUrl:"https://github.com/openbao/openbao/tree/main/website/content/docs/commands/operator/diagnose.mdx",tags:[],version:"current",frontMatter:{layout:"docs",page_title:"operator diagnose - Command",description:'"bao operator diagnose" is a new operator-centric command, focused on providing a clear description \nof what is working in OpenBao, and what is not working. The command focuses on why OpenBao cannot serve requests,\nbut will also warn on configurations or statuses that it deems to be unsafe in some way. '},sidebar:"docs",previous:{title:"operator",permalink:"/openbao/docs/commands/operator/"},next:{title:"operator generate-root",permalink:"/openbao/docs/commands/operator/generate-root"}},c={},h=[{value:"Usage",id:"usage",level:2},{value:"Output options",id:"output-options",level:3},{value:"Output layout",id:"output-layout",level:4},{value:"Command options",id:"command-options",level:3},{value:"Diagnose checks",id:"diagnose-checks",level:3},{value:"OpenBao diagnose",id:"openbao-diagnose",level:4},{value:"Check operating system / check open file limit",id:"check-operating-system--check-open-file-limit",level:4},{value:"Check operating system / check disk usage",id:"check-operating-system--check-disk-usage",level:4},{value:"Parse configuration",id:"parse-configuration",level:4},{value:"Check storage / create storage backend",id:"check-storage--create-storage-backend",level:4},{value:"Check storage / check raft folder permissions",id:"check-storage--check-raft-folder-permissions",level:4},{value:"Check storage / check raft folder ownership",id:"check-storage--check-raft-folder-ownership",level:4},{value:"Check storage / check for raft quorum",id:"check-storage--check-for-raft-quorum",level:4},{value:"Check storage / check storage access",id:"check-storage--check-storage-access",level:4},{value:"Check service discovery / check consul service discovery TLS",id:"check-service-discovery--check-consul-service-discovery-tls",level:4},{value:"Check service discovery / check consul direct service discovery",id:"check-service-discovery--check-consul-direct-service-discovery",level:4},{value:"Create OpenBao server configuration seals",id:"create-openbao-server-configuration-seals",level:4},{value:"Check transit seal TLS",id:"check-transit-seal-tls",level:4},{value:"Create core configuration / initialize randomness for core",id:"create-core-configuration--initialize-randomness-for-core",level:4},{value:"HA storage",id:"ha-storage",level:4},{value:"Determine redirect address",id:"determine-redirect-address",level:4},{value:"Check cluster address",id:"check-cluster-address",level:4},{value:"Check core creation",id:"check-core-creation",level:4},{value:"Start listeners / check listener TLS",id:"start-listeners--check-listener-tls",level:4},{value:"Start listeners / create listeners",id:"start-listeners--create-listeners",level:4},{value:"Check autounseal encryption",id:"check-autounseal-encryption",level:4},{value:"Check server before runtime",id:"check-server-before-runtime",level:4}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"operator-diagnose",children:"operator diagnose"}),"\n",(0,i.jsx)(n.p,{children:"The operator diagnose command should be used primarily when OpenBao is down or\npartially inoperational. The command can be used safely regardless of the state\nOpenBao is in, but may return meaningless results for some of the test cases if the\nOpenBao server is already running."}),"\n",(0,i.jsx)(n.p,{children:"Note: if you run the diagnose command proactively, either before a server\nstarts or while a server is operational, please consult the documentation\non the individual checks below to see which checks are returning false error\nmessages or warnings."}),"\n",(0,i.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,i.jsxs)(n.p,{children:["The following flags are available in addition to the ",(0,i.jsx)(n.a,{href:"/docs/commands",children:"standard set of\nflags"})," included on all commands."]}),"\n",(0,i.jsx)(n.h3,{id:"output-options",children:"Output options"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"-format"})," ",(0,i.jsx)(n.code,{children:'(string: "table")'}),' - Print the output in the given format. Valid\nformats are "table", "json", or "yaml". This can also be specified via the\n',(0,i.jsx)(n.code,{children:"VAULT_FORMAT"})," environment variable."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"output-layout",children:"Output layout"}),"\n",(0,i.jsx)(n.p,{children:"The operator diagnose command will output a set of lines in the CLI.\nEach line will begin with a prefix in parenthesis. These are:."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"[ success ]"})," - Denotes that the check was successful."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"[ warning ]"})," - Denotes that the check has passed, but that there may be potential\nissues to look into that may relate to the issues OpenBao is experiencing. Diagnose warns\nfrequently. These warnings are meant to serve as starting points in the debugging process."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"[ failure ]"})," - Denotes that the check has failed. Failures are critical issues in the eyes\nof the diagnose command."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In addition to these prefixed lines, there may be output lines that are not prefixed, but are\ncolor-coded purple. These are advice lines from Diagnose, and are meant to offer general guidance\non how to go about fixing potential warnings or failures that may arise."}),"\n",(0,i.jsxs)(n.p,{children:["Warn or fail prefixes in nested checks will bubble up to the parent if the prefix superceeds the\nparent prefix. Fail superceeds warn, and warn superceeds ok. For example, if the TLS checks under\nthe Storage check fails, the ",(0,i.jsx)(n.code,{children:"[ failure ]"})," prefix will bubble up to the Storage check."]}),"\n",(0,i.jsx)(n.h3,{id:"command-options",children:"Command options"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"-config"})," ",(0,i.jsx)(n.code,{children:'(string; "")'})," - The path to the OpenBao configuration file used by\nthe OpenBao server on startup."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"diagnose-checks",children:"Diagnose checks"}),"\n",(0,i.jsxs)(n.p,{children:["The following section details the various checks that Diagnose runs. Check names in documentation\nwill be separated by slashes to denote that they are nested, when applicable. For example, a check\ndocumented as ",(0,i.jsx)(n.code,{children:"A / B"})," will show up as ",(0,i.jsx)(n.code,{children:"B"})," in the ",(0,i.jsx)(n.code,{children:"operator diagnose"})," output, and will be nested\n(indented) under ",(0,i.jsx)(n.code,{children:"A"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"openbao-diagnose",children:"OpenBao diagnose"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"OpenBao Diagnose"})," is the top level check that contains the rest of the checks. It will report the status\nof the check"]}),"\n",(0,i.jsx)(n.h4,{id:"check-operating-system--check-open-file-limit",children:"Check operating system / check open file limit"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Open File Limit"})," verifies that the open file limit value is set high enough for OpenBao\nto run effectively. We recommend setting these limits to at least 1024768."]}),"\n",(0,i.jsx)(n.p,{children:"This check will be skipped on openbsd, arm, and windows."}),"\n",(0,i.jsx)(n.h4,{id:"check-operating-system--check-disk-usage",children:"Check operating system / check disk usage"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Disk Usage"})," will report disk usage for each partition. For each partition on a prod host,\nwe recommend having at least 5% of the partition free to use, and at least 1 GB of space."]}),"\n",(0,i.jsx)(n.p,{children:"This check will be skipped on openbsd and arm."}),"\n",(0,i.jsx)(n.h4,{id:"parse-configuration",children:"Parse configuration"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Parse Configuration"}),' will check the OpenBao server config file for syntax errors. It will check\nfor extra values in the configuration file, repeated stanzas, and stanzas that do not belong\nin the configuration file (for example a "tcpp" listener as opposed to a tcp listener).']}),"\n",(0,i.jsxs)(n.p,{children:["Currently, the ",(0,i.jsx)(n.code,{children:"storage"})," stanza is not checked."]}),"\n",(0,i.jsx)(n.h4,{id:"check-storage--create-storage-backend",children:"Check storage / create storage backend"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Create Storage Backend"})," ensures that the storage stanza configured in the OpenBao server config\nhas enough information to create a storage object internally. Common errors will have to do\nwith misconfigured fields in the storage stanza."]}),"\n",(0,i.jsx)(n.h4,{id:"check-storage--check-raft-folder-permissions",children:"Check storage / check raft folder permissions"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Raft Folder Permissions"})," computes the permissions on the raft folder, checks that a boltDB file\nhas been initialized within the folder previously, and ensures that the folder is not too permissive, but\nat the same time has enough permissions to be used. The raft folder should not have ",(0,i.jsx)(n.code,{children:"other"})," permissions, but\nshould have ",(0,i.jsx)(n.code,{children:"group rw"})," or ",(0,i.jsx)(n.code,{children:"owner rw"}),", depending on different setups. This check also warns if it detects a\nsymlink being used."]}),"\n",(0,i.jsx)(n.p,{children:"Note that this check will warn that a raft file has not been created if diagnose is run without any\npre-existing server runs."}),"\n",(0,i.jsx)(n.p,{children:"This check will be skipped on windows."}),"\n",(0,i.jsx)(n.h4,{id:"check-storage--check-raft-folder-ownership",children:"Check storage / check raft folder ownership"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Raft Folder Ownership"})," ensures that OpenBao does not need to run as root to access the boltDB folder."]}),"\n",(0,i.jsx)(n.p,{children:"Note that this check will warn that a raft file has not been created if diagnose is run without any\npre-existing server runs."}),"\n",(0,i.jsx)(n.p,{children:"This check will be skipped on windows."}),"\n",(0,i.jsx)(n.h4,{id:"check-storage--check-for-raft-quorum",children:"Check storage / check for raft quorum"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check For Raft Quorum"})," uses the FSM to ensure that there were an odd number of voters in the raft quorum when\nOpenBao was last running."]}),"\n",(0,i.jsx)(n.p,{children:"Note that this check will warn that there are 0 voters if diagnose is run without any pre-existing server runs."}),"\n",(0,i.jsx)(n.h4,{id:"check-storage--check-storage-access",children:"Check storage / check storage access"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Storage Access"})," will try to write a dud value, named ",(0,i.jsx)(n.code,{children:"diagnose/latency/<uuid>"}),", to storage.\nEnsure that there is no important data at this location before running diagnose, as this check\nwill overwrite that data. This check will then try to list and read the value it wrote to ensure\nthe name and value is as expected."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Storage Access"})," will warn if any operation takes longer than 100ms, and error out if the\nentire check takes longer than 30s."]}),"\n",(0,i.jsx)(n.h4,{id:"check-service-discovery--check-consul-service-discovery-tls",children:"Check service discovery / check consul service discovery TLS"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Consul Service Discovery TLS"})," verifies TLS information included in the service discovery\nstanza if the storage type is consul. If a certificate chain is provided, Diagnose parses\nthe root, intermediate, and leaf certificates, and checks each one for correctness."]}),"\n",(0,i.jsx)(n.h4,{id:"check-service-discovery--check-consul-direct-service-discovery",children:"Check service discovery / check consul direct service discovery"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Consul Direct Service Discovery"})," is a consul-specific check that ensures OpenBao\nis not accessing the consul server directly, but rather through a local agent."]}),"\n",(0,i.jsx)(n.h4,{id:"create-openbao-server-configuration-seals",children:"Create OpenBao server configuration seals"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Create OpenBao Server Configuration Seals"})," creates seals from the OpenBao configuration\nstanza and verifies they can be initialized and finalized."]}),"\n",(0,i.jsx)(n.h4,{id:"check-transit-seal-tls",children:"Check transit seal TLS"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Transit Seal TLS"})," checks the TLS client certificate, key, and CA certificate\nprovided in a transit seal stanza (if one exists) for correctness."]}),"\n",(0,i.jsx)(n.h4,{id:"create-core-configuration--initialize-randomness-for-core",children:"Create core configuration / initialize randomness for core"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Initialize Randomness for Core"})," ensures that OpenBao has access to the randReader that\nthe OpenBao core uses."]}),"\n",(0,i.jsx)(n.h4,{id:"ha-storage",children:"HA storage"}),"\n",(0,i.jsxs)(n.p,{children:["This check and any nested checks will be the same as the ",(0,i.jsx)(n.code,{children:"Check Storage"})," checks.\nThe only difference is that the checks here will be run on whatever is specified in the\n",(0,i.jsx)(n.code,{children:"ha_storage"})," section of the OpenBao configuration, as opposed to the ",(0,i.jsx)(n.code,{children:"storage"})," section."]}),"\n",(0,i.jsx)(n.h4,{id:"determine-redirect-address",children:"Determine redirect address"}),"\n",(0,i.jsxs)(n.p,{children:["Ensures that one of the ",(0,i.jsx)(n.code,{children:"VAULT_API_ADDR"}),", ",(0,i.jsx)(n.code,{children:"VAULT_REDIRECT_ADDR"}),", or ",(0,i.jsx)(n.code,{children:"VAULT_ADVERTISE_ADDR"}),"\nenvironment variables are set, or that the redirect address is specified in the OpenBao\nconfiguration."]}),"\n",(0,i.jsx)(n.h4,{id:"check-cluster-address",children:"Check cluster address"}),"\n",(0,i.jsxs)(n.p,{children:["Parses the cluster address from the ",(0,i.jsx)(n.code,{children:"VAULT_CLUSTER_ADDR"})," environment variable, or from the\nredirect address or cluster address specified in the OpenBao configuration, and checks that\nthe address is of the form ",(0,i.jsx)(n.code,{children:"host:port"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"check-core-creation",children:"Check core creation"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Core Creation"})," verifies the logical configuration checks that OpenBao does when it\ncreates a core object. These are runtime checks, meaning any errors thrown by this diagnose\ntest will also be thrown by the OpenBao server itself when it is run."]}),"\n",(0,i.jsx)(n.h4,{id:"start-listeners--check-listener-tls",children:"Start listeners / check listener TLS"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Listener TLS"})," verifies the server certificate file and key are valid and matching.\nIt also checks the client CA file, if one is provided, for a valid certificate, and performs\nthe standard runtime listener checks on the listener configuration stanza, such as verifying\nthat the minimum and maximum TLS versions are within the bounds of what OpenBao supports."]}),"\n",(0,i.jsx)(n.p,{children:"Like all the other Diagnose TLS checks, it will warn if any of the certificates provided are\nset to expire within the next month."}),"\n",(0,i.jsx)(n.h4,{id:"start-listeners--create-listeners",children:"Start listeners / create listeners"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Create Listeners"})," uses the listener configuration to initialize the listeners, erroring with\na server error if anything goes wrong."]}),"\n",(0,i.jsx)(n.h4,{id:"check-autounseal-encryption",children:"Check autounseal encryption"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Autounseal Encryption"})," will initialize the barrier using the seal stanza, if the seal\ntype is not a shamir seal, and use it to encrypt and decrypt a dud value."]}),"\n",(0,i.jsx)(n.h4,{id:"check-server-before-runtime",children:"Check server before runtime"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"Check Server Before Runtime"})," achieves parity with the server run command, running through\nthe runtime code checks before the server is initialized to ensure that nothing fails.\nThis check will never fail without another diagnose check failing."]})]})}function l(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>a});var i=s(96540);const r={},t=i.createContext(r);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);